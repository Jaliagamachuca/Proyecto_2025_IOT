Index: app/src/main/java/com/example/proyecto_2025/data/auth/AuthRepository.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.example.proyecto_2025.data.auth;\r\n\r\nimport com.google.firebase.auth.*;\r\nimport com.google.firebase.firestore.*;\r\nimport java.util.*;\r\nimport static com.google.firebase.firestore.FieldValue.serverTimestamp;\r\n\r\npublic class AuthRepository {\r\n    private final FirebaseAuth auth = FirebaseAuth.getInstance();\r\n    private final FirebaseFirestore db = FirebaseFirestore.getInstance();\r\n\r\n    public interface Callback<T> { void onSuccess(T t); void onError(Exception e); }\r\n\r\n    // LOGIN\r\n    public void login(String email, String pass, Callback<DocumentSnapshot> cb) {\r\n        auth.signInWithEmailAndPassword(email, pass)\r\n                .addOnSuccessListener(r ->\r\n                        db.collection(\"users\").document(r.getUser().getUid()).get()\r\n                                .addOnSuccessListener(snap -> {\r\n                                    if (!snap.exists()) { cb.onError(new Exception(\"Perfil no encontrado.\")); return; }\r\n                                    String status = snap.getString(\"status\");\r\n                                    if (!\"active\".equals(status)) { cb.onError(new Exception(\"Usuario deshabilitado.\")); return; }\r\n                                    cb.onSuccess(snap);\r\n                                })\r\n                                .addOnFailureListener(cb::onError)\r\n                )\r\n                .addOnFailureListener(cb::onError);\r\n    }\r\n\r\n    public void signUp(String name, String email, String pass, String role, Callback<Void> cb) {\r\n        auth.createUserWithEmailAndPassword(email, pass)\r\n                .addOnSuccessListener(r -> {\r\n                    String uid = r.getUser().getUid();\r\n                    Map<String,Object> m = new HashMap<>();\r\n                    m.put(\"uid\", uid);\r\n                    m.put(\"email\", email);\r\n                    m.put(\"displayName\", name);\r\n                    m.put(\"role\", role.toLowerCase());\r\n                    m.put(\"status\", \"active\");\r\n                    m.put(\"companyId\", null);\r\n                    m.put(\"createdAt\", serverTimestamp());\r\n                    m.put(\"updatedAt\", serverTimestamp());\r\n                    db.collection(\"users\").document(uid).set(m)\r\n                            .addOnSuccessListener(v -> cb.onSuccess(null))\r\n                            .addOnFailureListener(cb::onError);\r\n                })\r\n                .addOnFailureListener(cb::onError);\r\n    }\r\n\r\n    // Buscar usuario por email (para promoción)\r\n    public void findUserByEmail(String email, Callback<QuerySnapshot> cb){\r\n        db.collection(\"users\")\r\n                .whereEqualTo(\"email\", email).limit(1)\r\n                .get()\r\n                .addOnSuccessListener(cb::onSuccess)\r\n                .addOnFailureListener(cb::onError);\r\n    }\r\n\r\n    // Promover a admin (cambia role + companyId)\r\n    public void promoteToAdmin(String uid, String companyId, Callback<Void> cb){\r\n        Map<String,Object> m = new HashMap<>();\r\n        m.put(\"role\",\"admin\");\r\n        m.put(\"companyId\", companyId);\r\n        m.put(\"updatedAt\", FieldValue.serverTimestamp());\r\n        db.collection(\"users\").document(uid).update(m)\r\n                .addOnSuccessListener(v -> cb.onSuccess(null))\r\n                .addOnFailureListener(cb::onError);\r\n    }\r\n\r\n    // (Opcional) Crear admin desde cero (Auth + Firestore)\r\n    public void createAdminFromScratch(String name, String email, String pass, String companyId, Callback<Void> cb){\r\n        auth.createUserWithEmailAndPassword(email, pass)\r\n                .addOnSuccessListener(r -> {\r\n                    String uid = r.getUser().getUid();\r\n                    Map<String,Object> u = new HashMap<>();\r\n                    u.put(\"uid\", uid);\r\n                    u.put(\"email\", email);\r\n                    u.put(\"displayName\", name);\r\n                    u.put(\"role\", \"admin\");\r\n                    u.put(\"status\", \"active\");\r\n                    u.put(\"companyId\", companyId);\r\n                    u.put(\"createdAt\", FieldValue.serverTimestamp());\r\n                    u.put(\"updatedAt\", FieldValue.serverTimestamp());\r\n                    db.collection(\"users\").document(uid).set(u)\r\n                            .addOnSuccessListener(x -> cb.onSuccess(null))\r\n                            .addOnFailureListener(cb::onError);\r\n                })\r\n                .addOnFailureListener(cb::onError);\r\n    }\r\n\r\n    public void logout(){ auth.signOut(); }\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/example/proyecto_2025/data/auth/AuthRepository.java b/app/src/main/java/com/example/proyecto_2025/data/auth/AuthRepository.java
--- a/app/src/main/java/com/example/proyecto_2025/data/auth/AuthRepository.java	(revision fcc14c26a711c5d7e134392a3aa3cdcefd4ac423)
+++ b/app/src/main/java/com/example/proyecto_2025/data/auth/AuthRepository.java	(date 1761943091728)
@@ -1,92 +1,111 @@
 package com.example.proyecto_2025.data.auth;
 
-import com.google.firebase.auth.*;
+import com.google.firebase.auth.AuthResult;
+import com.google.firebase.auth.FirebaseAuth;
+import com.google.firebase.auth.FirebaseUser;
 import com.google.firebase.firestore.*;
-import java.util.*;
-import static com.google.firebase.firestore.FieldValue.serverTimestamp;
+
+import java.util.HashMap;
+import java.util.Map;
+import java.util.Random;
 
 public class AuthRepository {
+
     private final FirebaseAuth auth = FirebaseAuth.getInstance();
     private final FirebaseFirestore db = FirebaseFirestore.getInstance();
 
-    public interface Callback<T> { void onSuccess(T t); void onError(Exception e); }
-
-    // LOGIN
-    public void login(String email, String pass, Callback<DocumentSnapshot> cb) {
-        auth.signInWithEmailAndPassword(email, pass)
-                .addOnSuccessListener(r ->
-                        db.collection("users").document(r.getUser().getUid()).get()
-                                .addOnSuccessListener(snap -> {
-                                    if (!snap.exists()) { cb.onError(new Exception("Perfil no encontrado.")); return; }
-                                    String status = snap.getString("status");
-                                    if (!"active".equals(status)) { cb.onError(new Exception("Usuario deshabilitado.")); return; }
-                                    cb.onSuccess(snap);
-                                })
-                                .addOnFailureListener(cb::onError)
-                )
-                .addOnFailureListener(cb::onError);
-    }
-
-    public void signUp(String name, String email, String pass, String role, Callback<Void> cb) {
-        auth.createUserWithEmailAndPassword(email, pass)
-                .addOnSuccessListener(r -> {
-                    String uid = r.getUser().getUid();
-                    Map<String,Object> m = new HashMap<>();
-                    m.put("uid", uid);
-                    m.put("email", email);
-                    m.put("displayName", name);
-                    m.put("role", role.toLowerCase());
-                    m.put("status", "active");
-                    m.put("companyId", null);
-                    m.put("createdAt", serverTimestamp());
-                    m.put("updatedAt", serverTimestamp());
-                    db.collection("users").document(uid).set(m)
-                            .addOnSuccessListener(v -> cb.onSuccess(null))
-                            .addOnFailureListener(cb::onError);
-                })
-                .addOnFailureListener(cb::onError);
+    public interface Callback<T> {
+        void onSuccess(T t);
+        void onError(Exception e);
     }
 
-    // Buscar usuario por email (para promoción)
-    public void findUserByEmail(String email, Callback<QuerySnapshot> cb){
-        db.collection("users")
-                .whereEqualTo("email", email).limit(1)
-                .get()
-                .addOnSuccessListener(cb::onSuccess)
-                .addOnFailureListener(cb::onError);
+    // genera código de 6 dígitos
+    private String genCode() {
+        int n = new Random().nextInt(900000) + 100000; // 100000..999999
+        return String.valueOf(n);
     }
 
-    // Promover a admin (cambia role + companyId)
-    public void promoteToAdmin(String uid, String companyId, Callback<Void> cb){
-        Map<String,Object> m = new HashMap<>();
-        m.put("role","admin");
-        m.put("companyId", companyId);
-        m.put("updatedAt", FieldValue.serverTimestamp());
-        db.collection("users").document(uid).update(m)
-                .addOnSuccessListener(v -> cb.onSuccess(null))
-                .addOnFailureListener(cb::onError);
-    }
+    /**
+     * REGISTRO de cliente/guia
+     * - cliente: status=active, dni=null
+     * - guia:    status=pending, dni=OJO (de momento null -> lo completa después)
+     */
+    public void signUp(String name,
+                       String email,
+                       String pass,
+                       String role,
+                       Callback<Void> cb) {
 
-    // (Opcional) Crear admin desde cero (Auth + Firestore)
-    public void createAdminFromScratch(String name, String email, String pass, String companyId, Callback<Void> cb){
         auth.createUserWithEmailAndPassword(email, pass)
-                .addOnSuccessListener(r -> {
-                    String uid = r.getUser().getUid();
-                    Map<String,Object> u = new HashMap<>();
+                .addOnSuccessListener((AuthResult r) -> {
+                    FirebaseUser fUser = r.getUser();
+                    if (fUser == null) {
+                        cb.onError(new Exception("No se pudo crear el usuario."));
+                        return;
+                    }
+                    String uid = fUser.getUid();
+
+                    // status según rol
+                    String status = "active";
+                    if ("guia".equalsIgnoreCase(role)) {
+                        status = "pending";
+                    }
+
+                    // código de verificación interno
+                    String code = genCode();
+
+                    Map<String, Object> u = new HashMap<>();
                     u.put("uid", uid);
-                    u.put("email", email);
                     u.put("displayName", name);
-                    u.put("role", "admin");
-                    u.put("status", "active");
-                    u.put("companyId", companyId);
+                    u.put("email", email);
+                    u.put("role", role.toLowerCase());
+                    u.put("status", status);
+                    u.put("dni", null);                   // guia/admin lo completan
+                    u.put("phone", null);
+                    u.put("photoUrl", "https://example.com/default-user.png"); // placeholder
+                    u.put("companyId", null);             // solo admin tendrá esto
+                    u.put("emailVerified", false);        // hasta que ponga el código
+                    u.put("verificationCode", code);      // 6 dígitos
+                    u.put("verificationRequired", true);  // para que el login lo chequee
                     u.put("createdAt", FieldValue.serverTimestamp());
                     u.put("updatedAt", FieldValue.serverTimestamp());
+
                     db.collection("users").document(uid).set(u)
-                            .addOnSuccessListener(x -> cb.onSuccess(null))
+                            .addOnSuccessListener(x -> {
+                                // dispara verificación de Firebase (link)
+                                fUser.sendEmailVerification();
+                                // el correo con el CODE lo puedes armar en tu activity
+                                cb.onSuccess(null);
+                            })
+                            .addOnFailureListener(cb::onError);
+                })
+                .addOnFailureListener(cb::onError);
+    }
+
+    /**
+     * LOGIN → devuelve doc de Firestore
+     */
+    public void login(String email, String pass, Callback<DocumentSnapshot> cb) {
+        auth.signInWithEmailAndPassword(email, pass)
+                .addOnSuccessListener((AuthResult r) -> {
+                    FirebaseUser fUser = auth.getCurrentUser();
+                    if (fUser == null) {
+                        cb.onError(new Exception("No se encontró el usuario."));
+                        return;
+                    }
+                    String uid = fUser.getUid();
+                    db.collection("users").document(uid).get()
+                            .addOnSuccessListener(cb::onSuccess)
                             .addOnFailureListener(cb::onError);
                 })
                 .addOnFailureListener(cb::onError);
     }
 
-    public void logout(){ auth.signOut(); }
+    public FirebaseUser getCurrentUser() {
+        return auth.getCurrentUser();
+    }
+
+    public void signOut() {
+        auth.signOut();
+    }
 }
Index: app/src/main/res/layout/activity_registro.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n<ScrollView xmlns:android=\"http://schemas.android.com/apk/res/android\"\r\n    xmlns:app=\"http://schemas.android.com/apk/res-auto\"\r\n    android:layout_width=\"match_parent\"\r\n    android:layout_height=\"match_parent\"\r\n    android:background=\"#FFFFFF\">\r\n\r\n    <LinearLayout\r\n        android:layout_width=\"match_parent\"\r\n        android:layout_height=\"wrap_content\"\r\n        android:orientation=\"vertical\"\r\n        android:padding=\"24dp\">\r\n\r\n        <LinearLayout\r\n            android:layout_width=\"match_parent\"\r\n            android:layout_height=\"wrap_content\"\r\n            android:orientation=\"horizontal\"\r\n            android:layout_marginBottom=\"16dp\">\r\n\r\n            <ImageButton\r\n                android:id=\"@+id/btn_volver\"\r\n                android:layout_width=\"40dp\"\r\n                android:layout_height=\"40dp\"\r\n                android:background=\"?android:attr/selectableItemBackgroundBorderless\"\r\n                android:src=\"@android:drawable/ic_menu_revert\"\r\n                android:contentDescription=\"Volver atrás\" />\r\n\r\n            <View\r\n                android:layout_width=\"0dp\"\r\n                android:layout_height=\"0dp\"\r\n                android:layout_weight=\"1\" />\r\n\r\n        </LinearLayout>\r\n\r\n\r\n        <!-- Header -->\r\n        <TextView\r\n            android:layout_width=\"wrap_content\"\r\n            android:layout_height=\"wrap_content\"\r\n            android:text=\"Regístrate\"\r\n            android:textSize=\"24sp\"\r\n            android:textStyle=\"bold\"\r\n            android:textColor=\"#000000\"\r\n            android:layout_marginBottom=\"8dp\" />\r\n\r\n        <TextView\r\n            android:layout_width=\"wrap_content\"\r\n            android:layout_height=\"wrap_content\"\r\n            android:text=\"Crea una cuenta para iniciar\"\r\n            android:textSize=\"14sp\"\r\n            android:textColor=\"#666666\"\r\n            android:layout_marginBottom=\"32dp\" />\r\n\r\n        <!-- Campo Nombre -->\r\n        <TextView\r\n            android:layout_width=\"wrap_content\"\r\n            android:layout_height=\"wrap_content\"\r\n            android:text=\"Nombre\"\r\n            android:textSize=\"14sp\"\r\n            android:textColor=\"#000000\"\r\n            android:textStyle=\"bold\"\r\n            android:layout_marginBottom=\"8dp\" />\r\n\r\n        <com.google.android.material.textfield.TextInputLayout\r\n            android:layout_width=\"match_parent\"\r\n            android:layout_height=\"wrap_content\"\r\n            android:layout_marginBottom=\"16dp\"\r\n            app:boxStrokeColor=\"#1976D2\"\r\n            app:boxStrokeWidth=\"2dp\">\r\n\r\n            <com.google.android.material.textfield.TextInputEditText\r\n                android:id=\"@+id/et_nombre\"\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:hint=\"Ingresa tu nombre completo\"\r\n                android:inputType=\"textPersonName\" />\r\n\r\n        </com.google.android.material.textfield.TextInputLayout>\r\n\r\n        <!-- Campo Correo electrónico -->\r\n        <TextView\r\n            android:layout_width=\"wrap_content\"\r\n            android:layout_height=\"wrap_content\"\r\n            android:text=\"Correo electrónico\"\r\n            android:textSize=\"14sp\"\r\n            android:textColor=\"#000000\"\r\n            android:textStyle=\"bold\"\r\n            android:layout_marginBottom=\"8dp\" />\r\n\r\n        <com.google.android.material.textfield.TextInputLayout\r\n            android:layout_width=\"match_parent\"\r\n            android:layout_height=\"wrap_content\"\r\n            android:layout_marginBottom=\"16dp\"\r\n            app:boxStrokeColor=\"#1976D2\"\r\n            app:boxStrokeWidth=\"2dp\">\r\n\r\n            <com.google.android.material.textfield.TextInputEditText\r\n                android:id=\"@+id/et_correo\"\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:hint=\"nombre@gmail.com\"\r\n                android:inputType=\"textEmailAddress\" />\r\n\r\n        </com.google.android.material.textfield.TextInputLayout>\r\n\r\n        <!-- Campo Contraseña -->\r\n        <TextView\r\n            android:layout_width=\"wrap_content\"\r\n            android:layout_height=\"wrap_content\"\r\n            android:text=\"Contraseña\"\r\n            android:textSize=\"14sp\"\r\n            android:textColor=\"#000000\"\r\n            android:textStyle=\"bold\"\r\n            android:layout_marginBottom=\"8dp\" />\r\n\r\n        <com.google.android.material.textfield.TextInputLayout\r\n            android:layout_width=\"match_parent\"\r\n            android:layout_height=\"wrap_content\"\r\n            android:layout_marginBottom=\"16dp\"\r\n            app:boxStrokeColor=\"#1976D2\"\r\n            app:boxStrokeWidth=\"2dp\"\r\n            app:passwordToggleEnabled=\"true\">\r\n\r\n            <com.google.android.material.textfield.TextInputEditText\r\n                android:id=\"@+id/et_password\"\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:hint=\"Crea tu contraseña\"\r\n                android:inputType=\"textPassword\" />\r\n\r\n        </com.google.android.material.textfield.TextInputLayout>\r\n\r\n        <!-- Campo Confirmar contraseña -->\r\n        <com.google.android.material.textfield.TextInputLayout\r\n            android:layout_width=\"match_parent\"\r\n            android:layout_height=\"wrap_content\"\r\n            android:layout_marginBottom=\"16dp\"\r\n            app:boxStrokeColor=\"#1976D2\"\r\n            app:boxStrokeWidth=\"2dp\"\r\n            app:passwordToggleEnabled=\"true\">\r\n\r\n            <com.google.android.material.textfield.TextInputEditText\r\n                android:id=\"@+id/et_confirm_password\"\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:hint=\"Confirmar contraseña\"\r\n                android:inputType=\"textPassword\" />\r\n\r\n        </com.google.android.material.textfield.TextInputLayout>\r\n\r\n        <!-- Campo Rol -->\r\n        <TextView\r\n            android:layout_width=\"wrap_content\"\r\n            android:layout_height=\"wrap_content\"\r\n            android:text=\"Rol\"\r\n            android:textSize=\"14sp\"\r\n            android:textColor=\"#000000\"\r\n            android:textStyle=\"bold\"\r\n            android:layout_marginBottom=\"8dp\" />\r\n\r\n        <com.google.android.material.textfield.TextInputLayout\r\n            android:layout_width=\"match_parent\"\r\n            android:layout_height=\"wrap_content\"\r\n            android:layout_marginBottom=\"16dp\"\r\n            app:boxStrokeColor=\"#1976D2\"\r\n            app:boxStrokeWidth=\"2dp\"\r\n            style=\"@style/Widget.MaterialComponents.TextInputLayout.OutlinedBox.ExposedDropdownMenu\">\r\n\r\n            <AutoCompleteTextView\r\n                android:id=\"@+id/spinner_rol\"\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:hint=\"Selecciona una opción\"\r\n                android:inputType=\"none\"\r\n                android:focusable=\"false\" />\r\n\r\n        </com.google.android.material.textfield.TextInputLayout>\r\n\r\n        <!-- Checkbox términos -->\r\n        <LinearLayout\r\n            android:layout_width=\"match_parent\"\r\n            android:layout_height=\"wrap_content\"\r\n            android:orientation=\"horizontal\"\r\n            android:layout_marginBottom=\"24dp\">\r\n\r\n            <CheckBox\r\n                android:id=\"@+id/cb_terminos\"\r\n                android:layout_width=\"wrap_content\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:layout_marginEnd=\"8dp\" />\r\n\r\n            <TextView\r\n                android:layout_width=\"0dp\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:layout_weight=\"1\"\r\n                android:text=\"He leído y acepto los Términos y Condiciones y la Política de Privacidad\"\r\n                android:textSize=\"12sp\"\r\n                android:textColor=\"#666666\"\r\n                android:lineSpacingExtra=\"2dp\" />\r\n\r\n        </LinearLayout>\r\n\r\n        <!-- Botón continuar -->\r\n        <Button\r\n            android:id=\"@+id/btn_continuar\"\r\n            android:layout_width=\"match_parent\"\r\n            android:layout_height=\"50dp\"\r\n            android:text=\"Continuar\"\r\n            android:textColor=\"#FFFFFF\"\r\n            android:backgroundTint=\"#1976D2\"\r\n            android:textSize=\"16sp\"\r\n            android:textStyle=\"bold\"\r\n            android:textAllCaps=\"false\" />\r\n\r\n    </LinearLayout>\r\n\r\n</ScrollView>
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/res/layout/activity_registro.xml b/app/src/main/res/layout/activity_registro.xml
--- a/app/src/main/res/layout/activity_registro.xml	(revision fcc14c26a711c5d7e134392a3aa3cdcefd4ac423)
+++ b/app/src/main/res/layout/activity_registro.xml	(date 1761943161902)
@@ -77,6 +77,24 @@
 
         </com.google.android.material.textfield.TextInputLayout>
 
+        <!-- DNI (solo guias) -->
+        <com.google.android.material.textfield.TextInputLayout
+            android:layout_width="match_parent"
+            android:layout_height="wrap_content"
+            android:layout_marginBottom="16dp"
+            app:boxStrokeColor="#1976D2"
+            app:boxStrokeWidth="2dp">
+
+            <com.google.android.material.textfield.TextInputEditText
+                android:id="@+id/et_dni"
+                android:layout_width="match_parent"
+                android:layout_height="wrap_content"
+                android:hint="DNI"
+                android:inputType="number"
+                android:visibility="gone"/>
+        </com.google.android.material.textfield.TextInputLayout>
+
+
         <!-- Campo Correo electrónico -->
         <TextView
             android:layout_width="wrap_content"
Index: app/src/main/java/com/example/proyecto_2025/login/RegistroActivity.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.example.proyecto_2025.login;\r\n\r\nimport android.os.Bundle;\r\nimport android.widget.ArrayAdapter;\r\nimport android.widget.AutoCompleteTextView;\r\nimport android.widget.CheckBox;\r\nimport android.widget.Toast;\r\nimport androidx.appcompat.app.AppCompatActivity;\r\n\r\nimport com.example.proyecto_2025.R;\r\nimport com.example.proyecto_2025.data.auth.AuthRepository;\r\nimport com.google.android.material.textfield.TextInputEditText;\r\n\r\npublic class RegistroActivity extends AppCompatActivity {\r\n    private AuthRepository repo;\r\n\r\n    private TextInputEditText etNombre, etCorreo, etPass, etPass2;\r\n    private AutoCompleteTextView rolView;\r\n    private CheckBox cbTerminos;\r\n\r\n    @Override protected void onCreate(Bundle b) {\r\n        super.onCreate(b);\r\n        setContentView(R.layout.activity_registro);\r\n        repo = new AuthRepository();\r\n\r\n        etNombre = findViewById(R.id.et_nombre);\r\n        etCorreo = findViewById(R.id.et_correo);\r\n        etPass   = findViewById(R.id.et_password);\r\n        etPass2  = findViewById(R.id.et_confirm_password);\r\n        rolView  = findViewById(R.id.spinner_rol);\r\n        cbTerminos = findViewById(R.id.cb_terminos);\r\n\r\n        // Dropdown de roles (\"cliente\" / \"guia\")\r\n        String[] roles = new String[]{\"cliente\",\"guia\"};\r\n        rolView.setAdapter(new ArrayAdapter<>(this, android.R.layout.simple_list_item_1, roles));\r\n        rolView.setText(roles[0], false); // valor por defecto\r\n\r\n        findViewById(R.id.btn_volver).setOnClickListener(v -> finish());\r\n\r\n        findViewById(R.id.btn_continuar).setOnClickListener(v -> {\r\n            String name  = safe(etNombre);\r\n            String email = safe(etCorreo);\r\n            String pass  = safe(etPass);\r\n            String pass2 = safe(etPass2);\r\n            String role  = safe(rolView).toLowerCase();\r\n\r\n            if (name.isEmpty() || email.isEmpty() || pass.isEmpty()) {\r\n                toast(\"Completa nombre, correo y contraseña.\"); return;\r\n            }\r\n            if (pass.length() < 6) { toast(\"La contraseña debe tener al menos 6 caracteres.\"); return; }\r\n            if (!pass.equals(pass2)) { toast(\"Las contraseñas no coinciden.\"); return; }\r\n            if (!role.equals(\"cliente\") && !role.equals(\"guia\")) { toast(\"Selecciona un rol válido.\"); return; }\r\n            if (!cbTerminos.isChecked()) { toast(\"Debes aceptar los términos y condiciones.\"); return; }\r\n\r\n            repo.signUp(name, email, pass, role, new AuthRepository.Callback<Void>() {\r\n                @Override public void onSuccess(Void unused) {\r\n                    toast(\"Cuenta creada. Inicia sesión.\"); finish();\r\n                }\r\n                @Override public void onError(Exception e) {\r\n                    toast(\"Error: \"+e.getMessage());\r\n                }\r\n            });\r\n        });\r\n    }\r\n\r\n    private String safe(TextInputEditText t){ return t.getText()==null? \"\": t.getText().toString().trim(); }\r\n    private String safe(AutoCompleteTextView t){ return t.getText()==null? \"\": t.getText().toString().trim(); }\r\n    private void toast(String m){ Toast.makeText(this,m,Toast.LENGTH_LONG).show(); }\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/example/proyecto_2025/login/RegistroActivity.java b/app/src/main/java/com/example/proyecto_2025/login/RegistroActivity.java
--- a/app/src/main/java/com/example/proyecto_2025/login/RegistroActivity.java	(revision fcc14c26a711c5d7e134392a3aa3cdcefd4ac423)
+++ b/app/src/main/java/com/example/proyecto_2025/login/RegistroActivity.java	(date 1761943185257)
@@ -1,10 +1,12 @@
 package com.example.proyecto_2025.login;
 
 import android.os.Bundle;
+import android.view.View;
 import android.widget.ArrayAdapter;
 import android.widget.AutoCompleteTextView;
 import android.widget.CheckBox;
 import android.widget.Toast;
+
 import androidx.appcompat.app.AppCompatActivity;
 
 import com.example.proyecto_2025.R;
@@ -12,13 +14,15 @@
 import com.google.android.material.textfield.TextInputEditText;
 
 public class RegistroActivity extends AppCompatActivity {
+
     private AuthRepository repo;
 
-    private TextInputEditText etNombre, etCorreo, etPass, etPass2;
+    private TextInputEditText etNombre, etCorreo, etPass, etPass2, etDni;
     private AutoCompleteTextView rolView;
     private CheckBox cbTerminos;
 
-    @Override protected void onCreate(Bundle b) {
+    @Override
+    protected void onCreate(Bundle b) {
         super.onCreate(b);
         setContentView(R.layout.activity_registro);
         repo = new AuthRepository();
@@ -29,11 +33,21 @@
         etPass2  = findViewById(R.id.et_confirm_password);
         rolView  = findViewById(R.id.spinner_rol);
         cbTerminos = findViewById(R.id.cb_terminos);
+        etDni    = findViewById(R.id.et_dni);  // agrega este campo en el XML
 
-        // Dropdown de roles ("cliente" / "guia")
         String[] roles = new String[]{"cliente","guia"};
         rolView.setAdapter(new ArrayAdapter<>(this, android.R.layout.simple_list_item_1, roles));
-        rolView.setText(roles[0], false); // valor por defecto
+        rolView.setText(roles[0], false);
+
+        // mostrar/ocultar dni según rol
+        rolView.setOnItemClickListener((parent, view, position, id) -> {
+            String r = roles[position];
+            if ("guia".equalsIgnoreCase(r)) {
+                if (etDni != null) etDni.setVisibility(View.VISIBLE);
+            } else {
+                if (etDni != null) etDni.setVisibility(View.GONE);
+            }
+        });
 
         findViewById(R.id.btn_volver).setOnClickListener(v -> finish());
 
@@ -43,6 +57,7 @@
             String pass  = safe(etPass);
             String pass2 = safe(etPass2);
             String role  = safe(rolView).toLowerCase();
+            String dni   = etDni != null ? safe(etDni) : "";
 
             if (name.isEmpty() || email.isEmpty() || pass.isEmpty()) {
                 toast("Completa nombre, correo y contraseña."); return;
@@ -51,13 +66,22 @@
             if (!pass.equals(pass2)) { toast("Las contraseñas no coinciden."); return; }
             if (!role.equals("cliente") && !role.equals("guia")) { toast("Selecciona un rol válido."); return; }
             if (!cbTerminos.isChecked()) { toast("Debes aceptar los términos y condiciones."); return; }
+            if ("guia".equals(role) && dni.isEmpty()) { toast("El guía debe ingresar DNI."); return; }
 
+            // registramos
             repo.signUp(name, email, pass, role, new AuthRepository.Callback<Void>() {
                 @Override public void onSuccess(Void unused) {
-                    toast("Cuenta creada. Inicia sesión."); finish();
+                    // aquí podrías mandar a ConfirmarEmailActivity
+                    if ("guia".equals(role)) {
+                        toast("Cuenta de guía creada. Revisa tu correo y espera aprobación.");
+                    } else {
+                        toast("Cuenta creada. Revisa tu correo y confirma con el código.");
+                    }
+                    finish();
                 }
+
                 @Override public void onError(Exception e) {
-                    toast("Error: "+e.getMessage());
+                    toast("Error: " + e.getMessage());
                 }
             });
         });
Index: app/src/main/java/com/example/proyecto_2025/login/CodigoConfirmacionActivity.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.example.proyecto_2025.login;\r\n\r\nimport android.content.Intent;\r\nimport android.os.Bundle;\r\nimport android.widget.Button;\r\nimport android.widget.ImageButton;\r\nimport androidx.appcompat.app.AppCompatActivity;\r\nimport com.example.proyecto_2025.R;\r\n\r\npublic class CodigoConfirmacionActivity extends AppCompatActivity {\r\n\r\n    private Button btnContinuar;\r\n    private ImageButton btnVolver;\r\n\r\n    @Override\r\n    protected void onCreate(Bundle savedInstanceState) {\r\n        super.onCreate(savedInstanceState);\r\n        setContentView(R.layout.activity_codigo_confirmacion_joaco);\r\n\r\n        initViews();\r\n        setupListeners();\r\n    }\r\n\r\n    private void initViews() {\r\n        btnContinuar = findViewById(R.id.btn_continuar);\r\n        btnVolver = findViewById(R.id.btn_volver);\r\n    }\r\n\r\n    private void setupListeners() {\r\n        btnVolver.setOnClickListener(v -> {\r\n            finish(); // Volver a la pantalla anterior\r\n        });\r\n\r\n        btnContinuar.setOnClickListener(v -> {\r\n            Intent intent = new Intent(this, CrearPasswordActivity.class);\r\n            startActivity(intent);\r\n        });\r\n    }\r\n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/example/proyecto_2025/login/CodigoConfirmacionActivity.java b/app/src/main/java/com/example/proyecto_2025/login/CodigoConfirmacionActivity.java
--- a/app/src/main/java/com/example/proyecto_2025/login/CodigoConfirmacionActivity.java	(revision fcc14c26a711c5d7e134392a3aa3cdcefd4ac423)
+++ b/app/src/main/java/com/example/proyecto_2025/login/CodigoConfirmacionActivity.java	(date 1761946380220)
@@ -15,7 +15,7 @@
     @Override
     protected void onCreate(Bundle savedInstanceState) {
         super.onCreate(savedInstanceState);
-        setContentView(R.layout.activity_codigo_confirmacion_joaco);
+        setContentView(R.layout.activity_codigo_confirmacion);
 
         initViews();
         setupListeners();
Index: app/src/main/java/com/example/proyecto_2025/login/LoginActivity.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.example.proyecto_2025.login;\r\n\r\nimport android.content.Intent;\r\nimport android.os.Bundle;\r\nimport android.widget.Toast;\r\nimport androidx.appcompat.app.AppCompatActivity;\r\n\r\nimport com.example.proyecto_2025.Activities_Administrador.Admin_HomeActivity;\r\nimport com.example.proyecto_2025.Activities_Guia.Guia_HomeActivity;\r\nimport com.example.proyecto_2025.Activities_Superadmin.Superadmin_HomeActivity;\r\nimport com.example.proyecto_2025.Activities_Usuario.Cliente_HomeActivity;\r\nimport com.example.proyecto_2025.R;\r\nimport com.example.proyecto_2025.data.auth.AuthRepository;\r\nimport com.google.android.material.textfield.TextInputEditText;\r\nimport com.google.firebase.firestore.DocumentSnapshot;\r\n\r\npublic class LoginActivity extends AppCompatActivity {\r\n    private AuthRepository repo;\r\n    private TextInputEditText etCorreo, etPassword;\r\n\r\n    @Override protected void onCreate(Bundle b) {\r\n        super.onCreate(b);\r\n        setContentView(R.layout.activity_login);\r\n\r\n        repo = new AuthRepository();\r\n        etCorreo   = findViewById(R.id.et_correo);\r\n        etPassword = findViewById(R.id.et_password);\r\n\r\n        findViewById(R.id.btn_acceder).setOnClickListener(v -> {\r\n            String email = etCorreo.getText() == null ? \"\" : etCorreo.getText().toString().trim();\r\n            String pass  = etPassword.getText() == null ? \"\" : etPassword.getText().toString();\r\n\r\n            if (email.isEmpty() || pass.isEmpty()) {\r\n                Toast.makeText(this,\"Ingresa correo y contraseña.\",Toast.LENGTH_SHORT).show();\r\n                return;\r\n            }\r\n\r\n            repo.login(email, pass, new AuthRepository.Callback<DocumentSnapshot>() {\r\n                @Override public void onSuccess(DocumentSnapshot snap) {\r\n                    routeByRole(snap.getString(\"role\"));\r\n                }\r\n                @Override public void onError(Exception e) {\r\n                    Toast.makeText(LoginActivity.this, \"Error: \"+e.getMessage(), Toast.LENGTH_LONG).show();\r\n                }\r\n            });\r\n        });\r\n\r\n        // (Opcional) listeners de “olvidaste contraseña” y “registrarse”\r\n        findViewById(R.id.txt_olvidaste_password).setOnClickListener(v -> {\r\n            String email = etCorreo.getText()==null? \"\" : etCorreo.getText().toString().trim();\r\n            if (email.isEmpty()) { Toast.makeText(this,\"Escribe tu correo arriba.\",Toast.LENGTH_SHORT).show(); return; }\r\n            com.google.firebase.auth.FirebaseAuth.getInstance()\r\n                    .sendPasswordResetEmail(email)\r\n                    .addOnSuccessListener(x -> Toast.makeText(this,\"Te enviamos un correo de recuperación.\",Toast.LENGTH_LONG).show())\r\n                    .addOnFailureListener(err -> Toast.makeText(this,err.getMessage(),Toast.LENGTH_LONG).show());\r\n        });\r\n\r\n        findViewById(R.id.txt_registrarse).setOnClickListener(v ->\r\n                startActivity(new Intent(this, RegistroActivity.class)));\r\n    }\r\n\r\n    private void routeByRole(String role){\r\n        Class<?> next = Cliente_HomeActivity.class;\r\n        if (\"superadmin\".equals(role)) next = Superadmin_HomeActivity.class;\r\n        else if (\"admin\".equals(role)) next = Admin_HomeActivity.class;\r\n        else if (\"guia\".equals(role))  next = Guia_HomeActivity.class;\r\n        startActivity(new Intent(this, next));\r\n        finish();\r\n    }\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/example/proyecto_2025/login/LoginActivity.java b/app/src/main/java/com/example/proyecto_2025/login/LoginActivity.java
--- a/app/src/main/java/com/example/proyecto_2025/login/LoginActivity.java	(revision fcc14c26a711c5d7e134392a3aa3cdcefd4ac423)
+++ b/app/src/main/java/com/example/proyecto_2025/login/LoginActivity.java	(date 1761943109148)
@@ -3,6 +3,7 @@
 import android.content.Intent;
 import android.os.Bundle;
 import android.widget.Toast;
+
 import androidx.appcompat.app.AppCompatActivity;
 
 import com.example.proyecto_2025.Activities_Administrador.Admin_HomeActivity;
@@ -15,10 +16,12 @@
 import com.google.firebase.firestore.DocumentSnapshot;
 
 public class LoginActivity extends AppCompatActivity {
+
     private AuthRepository repo;
     private TextInputEditText etCorreo, etPassword;
 
-    @Override protected void onCreate(Bundle b) {
+    @Override
+    protected void onCreate(Bundle b) {
         super.onCreate(b);
         setContentView(R.layout.activity_login);
 
@@ -37,24 +40,66 @@
 
             repo.login(email, pass, new AuthRepository.Callback<DocumentSnapshot>() {
                 @Override public void onSuccess(DocumentSnapshot snap) {
-                    routeByRole(snap.getString("role"));
+                    if (!snap.exists()) {
+                        Toast.makeText(LoginActivity.this, "Perfil no encontrado.", Toast.LENGTH_LONG).show();
+                        return;
+                    }
+                    String role = snap.getString("role");
+                    String status = snap.getString("status");
+                    Boolean verReq = snap.getBoolean("verificationRequired");
+                    Boolean emailVer = snap.getBoolean("emailVerified");
+
+                    if (status == null) status = "active";
+                    if (verReq == null) verReq = true;
+                    if (emailVer == null) emailVer = false;
+
+                    // si requiere verificación y todavía no está verificado → ir a activity de código
+                    if (verReq && !emailVer) {
+                        // abrir tu pantalla de código
+                        Intent i = new Intent(LoginActivity.this, CodigoConfirmacionActivity.class);
+                        i.putExtra("email", snap.getString("email"));
+                        startActivity(i);
+                        // no finish(); para que pueda volver
+                        return;
+                    }
+
+                    // guía pendiente
+                    if ("guia".equals(role) && "pending".equals(status)) {
+                        startActivity(new Intent(LoginActivity.this, PendienteGuiaActivity.class));
+                        finish();
+                        return;
+                    }
+
+                    // usuario deshabilitado
+                    if (!"active".equals(status) && !"superadmin".equals(role)) {
+                        Toast.makeText(LoginActivity.this, "Tu cuenta está deshabilitada.", Toast.LENGTH_LONG).show();
+                        repo.signOut();
+                        return;
+                    }
+
+                    routeByRole(role);
                 }
+
                 @Override public void onError(Exception e) {
                     Toast.makeText(LoginActivity.this, "Error: "+e.getMessage(), Toast.LENGTH_LONG).show();
                 }
             });
         });
 
-        // (Opcional) listeners de “olvidaste contraseña” y “registrarse”
+        // recuperar password
         findViewById(R.id.txt_olvidaste_password).setOnClickListener(v -> {
             String email = etCorreo.getText()==null? "" : etCorreo.getText().toString().trim();
-            if (email.isEmpty()) { Toast.makeText(this,"Escribe tu correo arriba.",Toast.LENGTH_SHORT).show(); return; }
+            if (email.isEmpty()) {
+                Toast.makeText(this,"Escribe tu correo arriba.",Toast.LENGTH_SHORT).show();
+                return;
+            }
             com.google.firebase.auth.FirebaseAuth.getInstance()
                     .sendPasswordResetEmail(email)
                     .addOnSuccessListener(x -> Toast.makeText(this,"Te enviamos un correo de recuperación.",Toast.LENGTH_LONG).show())
                     .addOnFailureListener(err -> Toast.makeText(this,err.getMessage(),Toast.LENGTH_LONG).show());
         });
 
+        // ir a registro
         findViewById(R.id.txt_registrarse).setOnClickListener(v ->
                 startActivity(new Intent(this, RegistroActivity.class)));
     }
Index: app/src/main/res/navigation/nav_graph.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n<navigation xmlns:android=\"http://schemas.android.com/apk/res/android\"\r\n    xmlns:app=\"http://schemas.android.com/apk/res-auto\"\r\n    xmlns:tools=\"http://schemas.android.com/tools\"\r\n    android:id=\"@+id/nav_graph\"\r\n    app:startDestination=\"@id/loginActivity\">\r\n\r\n    <!-- Flujo principal de Login y Registro -->\r\n    <activity\r\n        android:id=\"@+id/loginActivity\"\r\n        android:name=\"com.example.proyecto_2025.login.LoginActivity\"\r\n        android:label=\"Login\"\r\n        tools:layout=\"@layout/activity_login\">\r\n        <action\r\n            android:id=\"@+id/action_login_to_registro\"\r\n            app:destination=\"@id/registroActivity\" />\r\n        <action\r\n            android:id=\"@+id/action_login_to_recuperar_password\"\r\n            app:destination=\"@id/recuperarPasswordActivity\" />\r\n    </activity>\r\n\r\n    <activity\r\n        android:id=\"@+id/registroActivity\"\r\n        android:name=\"com.example.proyecto_2025.login.RegistroActivity\"\r\n        android:label=\"Registro\"\r\n        tools:layout=\"@layout/activity_registro\">\r\n        <action\r\n            android:id=\"@+id/action_registro_to_confirmacion\"\r\n            app:destination=\"@id/confirmacionActivity\" />\r\n    </activity>\r\n\r\n    <activity\r\n        android:id=\"@+id/confirmacionActivity\"\r\n        android:name=\"com.example.proyecto_2025.login.ConfirmacionActivity\"\r\n        android:label=\"Confirmación\"\r\n        tools:layout=\"@layout/activity_confirmacion_joaco\">\r\n        <action\r\n            android:id=\"@+id/action_confirmacion_to_exito_cliente\"\r\n            app:destination=\"@id/exitoClienteActivity\" />\r\n        <action\r\n            android:id=\"@+id/action_confirmacion_to_pendiente_guia\"\r\n            app:destination=\"@id/pendienteGuiaActivity\" />\r\n    </activity>\r\n\r\n    <!-- Pantallas finales según rol -->\r\n    <activity\r\n        android:id=\"@+id/exitoClienteActivity\"\r\n        android:name=\"com.example.proyecto_2025.login.ExitoClienteActivity\"\r\n        android:label=\"Cuenta Creada\"\r\n        tools:layout=\"@layout/activity_exito_cliente_joaco\" />\r\n\r\n    <activity\r\n        android:id=\"@+id/pendienteGuiaActivity\"\r\n        android:name=\"com.example.proyecto_2025.login.PendienteGuiaActivity\"\r\n        android:label=\"Pendiente Aprobación\"\r\n        tools:layout=\"@layout/activity_pendiente_guia_joaco\" />\r\n\r\n    <!-- Flujo de recuperación de contraseña -->\r\n    <activity\r\n        android:id=\"@+id/recuperarPasswordActivity\"\r\n        android:name=\"com.example.proyecto_2025.login.RecuperarPasswordActivity\"\r\n        android:label=\"Recuperar Contraseña\"\r\n        tools:layout=\"@layout/activity_recuperar_password_joaco\">\r\n        <action\r\n            android:id=\"@+id/action_recuperar_to_confirmar_email\"\r\n            app:destination=\"@id/confirmarEmailActivity\" />\r\n    </activity>\r\n\r\n    <activity\r\n        android:id=\"@+id/confirmarEmailActivity\"\r\n        android:name=\"com.example.proyecto_2025.login.ConfirmarEmailActivity\"\r\n        android:label=\"Confirmar Email\"\r\n        tools:layout=\"@layout/activity_confirmar_email_joaco\">\r\n        <action\r\n            android:id=\"@+id/action_confirmar_email_to_codigo\"\r\n            app:destination=\"@id/codigoConfirmacionActivity\" />\r\n    </activity>\r\n\r\n    <activity\r\n        android:id=\"@+id/codigoConfirmacionActivity\"\r\n        android:name=\"com.example.proyecto_2025.login.CodigoConfirmacionActivity\"\r\n        android:label=\"Código Confirmación\"\r\n        tools:layout=\"@layout/activity_codigo_confirmacion_joaco\">\r\n        <action\r\n            android:id=\"@+id/action_codigo_to_crear_password\"\r\n            app:destination=\"@id/crearPasswordActivity\" />\r\n    </activity>\r\n\r\n    <activity\r\n        android:id=\"@+id/crearPasswordActivity\"\r\n        android:name=\"com.example.proyecto_2025.login.CrearPasswordActivity\"\r\n        android:label=\"Crear Nueva Contraseña\"\r\n        tools:layout=\"@layout/activity_crear_password_joaco\" />\r\n\r\n</navigation>
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/res/navigation/nav_graph.xml b/app/src/main/res/navigation/nav_graph.xml
--- a/app/src/main/res/navigation/nav_graph.xml	(revision fcc14c26a711c5d7e134392a3aa3cdcefd4ac423)
+++ b/app/src/main/res/navigation/nav_graph.xml	(date 1761946380209)
@@ -80,7 +80,7 @@
         android:id="@+id/codigoConfirmacionActivity"
         android:name="com.example.proyecto_2025.login.CodigoConfirmacionActivity"
         android:label="Código Confirmación"
-        tools:layout="@layout/activity_codigo_confirmacion_joaco">
+        tools:layout="@layout/activity_codigo_confirmacion">
         <action
             android:id="@+id/action_codigo_to_crear_password"
             app:destination="@id/crearPasswordActivity" />
diff --git a/app/src/main/res/layout/activity_codigo_confirmacion_joaco.xml b/app/src/main/res/layout/activity_codigo_confirmacion.xml
rename from app/src/main/res/layout/activity_codigo_confirmacion_joaco.xml
rename to app/src/main/res/layout/activity_codigo_confirmacion.xml
