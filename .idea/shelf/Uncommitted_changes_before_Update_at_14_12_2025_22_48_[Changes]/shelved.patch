Index: app/src/main/java/com/example/proyecto_2025/data/repository/ChatRepository.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.example.proyecto_2025.data.repository;\r\n\r\nimport androidx.annotation.Nullable;\r\n\r\nimport com.example.proyecto_2025.model.ChatMessage;\r\nimport com.example.proyecto_2025.model.Conversation;\r\nimport com.google.firebase.firestore.DocumentReference;\r\nimport com.google.firebase.firestore.FieldValue;\r\nimport com.google.firebase.firestore.FirebaseFirestore;\r\nimport com.google.firebase.firestore.ListenerRegistration;\r\nimport com.google.firebase.firestore.Query;\r\n\r\nimport java.util.HashMap;\r\nimport java.util.Map;\r\n\r\npublic class ChatRepository {\r\n\r\n    private final FirebaseFirestore db = FirebaseFirestore.getInstance();\r\n\r\n    public interface ConversationsCb {\r\n        void onData(java.util.List<Conversation> list);\r\n        void onError(Exception e);\r\n    }\r\n\r\n    public interface MessagesCb {\r\n        void onData(java.util.List<ChatMessage> list);\r\n        void onError(Exception e);\r\n    }\r\n\r\n    public interface SimpleCb {\r\n        void onOk();\r\n        void onError(Exception e);\r\n    }\r\n\r\n    public ListenerRegistration listenMyConversations(String myUid, ConversationsCb cb) {\r\n        return db.collection(\"conversations\")\r\n                .whereArrayContains(\"participants\", myUid)\r\n                .orderBy(\"updatedAt\", Query.Direction.DESCENDING)\r\n                .addSnapshotListener((snap, e) -> {\r\n                    if (e != null) { cb.onError(e); return; }\r\n                    java.util.List<Conversation> out = new java.util.ArrayList<>();\r\n                    if (snap != null) {\r\n                        snap.getDocuments().forEach(d -> {\r\n                            Conversation c = d.toObject(Conversation.class);\r\n                            if (c != null) {\r\n                                c.id = d.getId();\r\n                                out.add(c);\r\n                            }\r\n                        });\r\n                    }\r\n                    cb.onData(out);\r\n                });\r\n    }\r\n\r\n    public ListenerRegistration listenMessages(String conversationId, MessagesCb cb) {\r\n        return db.collection(\"conversations\")\r\n                .document(conversationId)\r\n                .collection(\"messages\")\r\n                .orderBy(\"createdAt\", Query.Direction.ASCENDING)\r\n                .addSnapshotListener((snap, e) -> {\r\n                    if (e != null) { cb.onError(e); return; }\r\n                    java.util.List<ChatMessage> out = new java.util.ArrayList<>();\r\n                    if (snap != null) {\r\n                        snap.getDocuments().forEach(d -> {\r\n                            ChatMessage m = d.toObject(ChatMessage.class);\r\n                            if (m != null) {\r\n                                m.id = d.getId();\r\n                                out.add(m);\r\n                            }\r\n                        });\r\n                    }\r\n                    cb.onData(out);\r\n                });\r\n    }\r\n\r\n    public void sendMessage(String conversationId,\r\n                            String senderId,\r\n                            String text,\r\n                            @Nullable String otherUid,\r\n                            SimpleCb cb) {\r\n\r\n        String clean = (text == null) ? \"\" : text.trim();\r\n        if (clean.isEmpty()) { cb.onOk(); return; }\r\n\r\n        DocumentReference convRef = db.collection(\"conversations\").document(conversationId);\r\n        DocumentReference msgRef = convRef.collection(\"messages\").document();\r\n\r\n        Map<String, Object> msg = new HashMap<>();\r\n        msg.put(\"senderId\", senderId);\r\n        msg.put(\"text\", clean);\r\n        msg.put(\"createdAt\", FieldValue.serverTimestamp());\r\n\r\n        Map<String, Object> convUpd = new HashMap<>();\r\n        convUpd.put(\"lastMessage\", clean);\r\n        convUpd.put(\"lastSenderId\", senderId);\r\n        convUpd.put(\"updatedAt\", FieldValue.serverTimestamp());\r\n\r\n        convUpd.put(\"unread.\" + senderId, false);\r\n        if (otherUid != null && !otherUid.isEmpty()) {\r\n            convUpd.put(\"unread.\" + otherUid, true);\r\n        }\r\n\r\n        db.runBatch(b -> {\r\n                    b.set(msgRef, msg);\r\n                    b.update(convRef, convUpd);\r\n                }).addOnSuccessListener(v -> cb.onOk())\r\n                .addOnFailureListener(cb::onError);\r\n    }\r\n\r\n    public void markRead(String conversationId, String myUid) {\r\n        db.collection(\"conversations\")\r\n                .document(conversationId)\r\n                .update(\"unread.\" + myUid, false);\r\n    }\r\n\r\n    public String buildConversationId(String uidA, String uidB) {\r\n        if (uidA.compareTo(uidB) < 0) return uidA + \"_\" + uidB;\r\n        return uidB + \"_\" + uidA;\r\n    }\r\n\r\n    public void ensureConversation(String uidA, String roleA, String nameA, String photoA,\r\n                                   String uidB, String roleB, String nameB, String photoB,\r\n                                   SimpleCb cb) {\r\n\r\n        String id = buildConversationId(uidA, uidB);\r\n        DocumentReference convRef = db.collection(\"conversations\").document(id);\r\n\r\n        convRef.get().addOnSuccessListener(doc -> {\r\n            if (doc.exists()) { cb.onOk(); return; }\r\n\r\n            Map<String, Object> data = new HashMap<>();\r\n            java.util.List<String> participants = new java.util.ArrayList<>();\r\n            participants.add(uidA);\r\n            participants.add(uidB);\r\n\r\n            Map<String, String> roles = new HashMap<>();\r\n            roles.put(uidA, roleA);\r\n            roles.put(uidB, roleB);\r\n\r\n            Map<String, String> displayNames = new HashMap<>();\r\n            displayNames.put(uidA, nameA != null ? nameA : \"\");\r\n            displayNames.put(uidB, nameB != null ? nameB : \"\");\r\n\r\n            Map<String, String> photoUrls = new HashMap<>();\r\n            photoUrls.put(uidA, photoA != null ? photoA : \"\");\r\n            photoUrls.put(uidB, photoB != null ? photoB : \"\");\r\n\r\n            Map<String, Boolean> unread = new HashMap<>();\r\n            unread.put(uidA, false);\r\n            unread.put(uidB, false);\r\n\r\n            data.put(\"participants\", participants);\r\n            data.put(\"roles\", roles);\r\n            data.put(\"displayNames\", displayNames);\r\n            data.put(\"photoUrls\", photoUrls);\r\n            data.put(\"unread\", unread);\r\n            data.put(\"lastMessage\", \"\");\r\n            data.put(\"lastSenderId\", \"\");\r\n            data.put(\"updatedAt\", FieldValue.serverTimestamp());\r\n\r\n            convRef.set(data)\r\n                    .addOnSuccessListener(v -> cb.onOk())\r\n                    .addOnFailureListener(cb::onError);\r\n\r\n        }).addOnFailureListener(cb::onError);\r\n    }\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/example/proyecto_2025/data/repository/ChatRepository.java b/app/src/main/java/com/example/proyecto_2025/data/repository/ChatRepository.java
--- a/app/src/main/java/com/example/proyecto_2025/data/repository/ChatRepository.java	(revision 8e0c2c26e391b998bc9d9ddecd98e3b870cfe01b)
+++ b/app/src/main/java/com/example/proyecto_2025/data/repository/ChatRepository.java	(date 1765766871564)
@@ -2,7 +2,7 @@
 
 import androidx.annotation.Nullable;
 
-import com.example.proyecto_2025.model.ChatMessage;
+import com.example.proyecto_2025.model.ChatMsgAtencion;
 import com.example.proyecto_2025.model.Conversation;
 import com.google.firebase.firestore.DocumentReference;
 import com.google.firebase.firestore.FieldValue;
@@ -23,7 +23,7 @@
     }
 
     public interface MessagesCb {
-        void onData(java.util.List<ChatMessage> list);
+        void onData(java.util.List<ChatMsgAtencion> list);
         void onError(Exception e);
     }
 
@@ -59,10 +59,10 @@
                 .orderBy("createdAt", Query.Direction.ASCENDING)
                 .addSnapshotListener((snap, e) -> {
                     if (e != null) { cb.onError(e); return; }
-                    java.util.List<ChatMessage> out = new java.util.ArrayList<>();
+                    java.util.List<ChatMsgAtencion> out = new java.util.ArrayList<>();
                     if (snap != null) {
                         snap.getDocuments().forEach(d -> {
-                            ChatMessage m = d.toObject(ChatMessage.class);
+                            ChatMsgAtencion m = d.toObject(ChatMsgAtencion.class);
                             if (m != null) {
                                 m.id = d.getId();
                                 out.add(m);
@@ -154,6 +154,7 @@
             data.put("displayNames", displayNames);
             data.put("photoUrls", photoUrls);
             data.put("unread", unread);
+
             data.put("lastMessage", "");
             data.put("lastSenderId", "");
             data.put("updatedAt", FieldValue.serverTimestamp());
Index: app/src/main/java/com/example/proyecto_2025/Activities_Administrador/Admin_HomeActivity.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.example.proyecto_2025.Activities_Administrador;\r\nimport android.app.Activity;\r\nimport android.content.Intent;\r\nimport android.net.Uri;\r\nimport android.os.Bundle;\r\nimport android.util.Log;\r\nimport android.util.Patterns;\r\nimport android.view.MenuItem;\r\nimport android.view.View;\r\nimport android.widget.Button;\r\nimport android.widget.EditText;\r\nimport android.widget.TextView;\r\n\r\nimport androidx.activity.result.ActivityResultLauncher;\r\nimport androidx.activity.result.contract.ActivityResultContracts;\r\nimport androidx.annotation.IdRes;\r\nimport androidx.appcompat.app.AppCompatActivity;\r\nimport androidx.recyclerview.widget.LinearLayoutManager;\r\nimport androidx.recyclerview.widget.RecyclerView;\r\n\r\nimport com.bumptech.glide.Glide;\r\nimport com.example.proyecto_2025.Activities_Guia.EditarPerfilActivityGuia;\r\nimport com.example.proyecto_2025.Activities_Superadmin.CambiarFotoActivity;\r\nimport com.example.proyecto_2025.R;\r\nimport com.example.proyecto_2025.adapter.ConversationAdapter;\r\nimport com.example.proyecto_2025.adapter.ImageUriAdapter;\r\nimport com.example.proyecto_2025.adapter.GuideAdapter;\r\nimport com.example.proyecto_2025.adapter.OfferAdapter;\r\nimport com.example.proyecto_2025.adapter.TourAdapter;\r\nimport com.example.proyecto_2025.data.auth.AuthRepository;\r\nimport com.example.proyecto_2025.data.repository.EmpresaRepository;\r\nimport com.example.proyecto_2025.data.repository.TourRepository;\r\nimport com.example.proyecto_2025.data.repository.OfferRepository;\r\nimport com.example.proyecto_2025.data.repository.GuideRepository;\r\nimport com.example.proyecto_2025.data.repository.AdminRepository;\r\nimport com.example.proyecto_2025.databinding.ActivityAdminHomeBinding;\r\nimport com.example.proyecto_2025.login.LoginActivity;\r\nimport com.example.proyecto_2025.model.Empresa;\r\nimport com.example.proyecto_2025.model.Guide;\r\nimport com.example.proyecto_2025.model.Offer;\r\nimport com.example.proyecto_2025.model.Tour;\r\nimport com.example.proyecto_2025.model.TourEstado;\r\nimport com.example.proyecto_2025.model.Admin;\r\nimport com.example.proyecto_2025.model.User;\r\nimport com.google.android.material.snackbar.Snackbar;\r\nimport com.google.firebase.auth.FirebaseUser;\r\nimport com.google.firebase.auth.FirebaseAuth;\r\nimport com.google.firebase.firestore.FirebaseFirestore;\r\n\r\nimport androidx.appcompat.app.AlertDialog;\r\n\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\n\r\n\r\npublic class Admin_HomeActivity extends AppCompatActivity {\r\n\r\n    // ===================== BINDING & CONSTANTS =====================\r\n    private ActivityAdminHomeBinding binding;\r\n\r\n    private static final int SCR_EMPRESA  = R.id.scrEmpresa;\r\n    private static final int SCR_TOURS    = R.id.scrTours;\r\n    private static final int SCR_GUIAS    = R.id.scrGuias;\r\n    private static final int SCR_REPORTES = R.id.scrReportes;\r\n    private static final int SCR_CHAT = R.id.scrChat;\r\n\r\n    private static final int SCR_PERFIL   = R.id.scrPerfil;\r\n\r\n    // ===================== REPOSITORIES =====================\r\n    private EmpresaRepository empresaRepo;\r\n    private AdminRepository adminRepo;\r\n\r\n    // ===================== DATA MODELS =====================\r\n    private Empresa empresa;\r\n    private Admin admin;\r\n    private final List<Uri> galeriaUris = new ArrayList<>();\r\n    private final List<Guide> sugeridos = new ArrayList<>();\r\n    private GuideAdapter guiasAdapter;\r\n\r\n    // ===================== LAUNCHERS =====================\r\n    private ActivityResultLauncher<Intent> pickImagesLauncher;\r\n    private ActivityResultLauncher<Intent> pickLocationLauncher;\r\n\r\n    // ===================== TOURS (ADMIN) =====================\r\n    private TourRepository tourRepo;\r\n    private TourAdapter tourAdapter;\r\n    private final List<Tour> allTours = new ArrayList<>();\r\n    private String empresaId;\r\n    private ConversationAdapter chatAdapter;\r\n    private final List<com.example.proyecto_2025.model.ConversationUI> chatData = new ArrayList<>();\r\n\r\n\r\n    // Para extraer el guia actual y poner sus datos en el perfil\r\n    private final FirebaseFirestore db = FirebaseFirestore.getInstance();\r\n\r\n    // ===================== LIFECYCLE =====================\r\n    @Override\r\n    protected void onCreate(Bundle savedInstanceState) {\r\n        super.onCreate(savedInstanceState);\r\n        binding = ActivityAdminHomeBinding.inflate(getLayoutInflater());\r\n        setContentView(binding.getRoot());\r\n\r\n        // Configurar toolbar\r\n        setupToolbar();\r\n\r\n        // Inicializar repositorios y datos\r\n        initializeRepositories();\r\n\r\n        // Configurar launchers\r\n        setupLaunchers();\r\n\r\n        // Configurar bottom navigation\r\n        binding.bottomNav.setOnItemSelectedListener(this::onBottomItemSelected);\r\n\r\n        // Inicializar todas las secciones\r\n        initializeAllSections();\r\n        syncEmpresaFromRemote();\r\n\r\n        // Pantalla inicial\r\n        binding.bottomNav.setSelectedItemId(R.id.nav_empresa);\r\n        showScreen(SCR_EMPRESA);\r\n\r\n        // Datos de prueba (eliminar en producci├│n)\r\n        //crearDatosDePruebaSiEsNecesario();\r\n    }\r\n\r\n    // ===================== SETUP METHODS =====================\r\n\r\n    private void setupToolbar() {\r\n        setSupportActionBar(binding.toolbar);\r\n        if (getSupportActionBar() != null) {\r\n            getSupportActionBar().setTitle(\"\");\r\n            getSupportActionBar().setDisplayShowTitleEnabled(false);\r\n        }\r\n    }\r\n\r\n    private void initializeRepositories() {\r\n        GuideRepository.get().seedIfEmpty(this);\r\n        empresaRepo = new EmpresaRepository(this);\r\n        empresa = empresaRepo.load();\r\n        adminRepo = new AdminRepository(this);\r\n        admin = adminRepo.load();\r\n\r\n        // TOURS\r\n        tourRepo = new TourRepository(this);\r\n\r\n        // Usamos el UID del usuario logueado como empresaId (coincide con TourFormActivity)\r\n        FirebaseUser fbUser = FirebaseAuth.getInstance().getCurrentUser();\r\n        if (fbUser != null) {\r\n            empresaId = fbUser.getUid();\r\n        }\r\n    }\r\n    private void syncEmpresaFromRemote() {\r\n        empresaRepo.loadFromRemote(remoteEmpresa -> {\r\n            if (remoteEmpresa == null) return;\r\n\r\n            empresa = remoteEmpresa;\r\n\r\n            runOnUiThread(() -> {\r\n                // === Recargar UI de empresa con la data remota ===\r\n                binding.scrEmpresa.etNombre.setText(empresa.nombre);\r\n                binding.scrEmpresa.etCorreo.setText(empresa.correo);\r\n                binding.scrEmpresa.etTelefono.setText(empresa.telefono);\r\n                binding.scrEmpresa.etWeb.setText(empresa.web);\r\n                binding.scrEmpresa.etDescripcion.setText(empresa.descripcion);\r\n\r\n                if (empresa.direccion != null && !empresa.direccion.isEmpty()) {\r\n                    binding.scrEmpresa.tvDireccion.setText(empresa.direccion);\r\n                } else {\r\n                    binding.scrEmpresa.tvDireccion.setText(\"Sin dirección\");\r\n                }\r\n\r\n                // Galería\r\n                galeriaUris.clear();\r\n                for (String s : empresa.imagenUris) {\r\n                    try {\r\n                        galeriaUris.add(Uri.parse(s));\r\n                    } catch (Exception ignore) {}\r\n                }\r\n                if (binding.scrEmpresa.rvGaleria.getAdapter() != null) {\r\n                    binding.scrEmpresa.rvGaleria.getAdapter().notifyDataSetChanged();\r\n                }\r\n\r\n                updateMapPreview();\r\n                actualizarChecklistYEstado();\r\n            });\r\n        });\r\n    }\r\n\r\n    private void setupLaunchers() {\r\n        // Launcher para seleccionar im├ígenes\r\n        pickImagesLauncher = registerForActivityResult(\r\n                new ActivityResultContracts.StartActivityForResult(), result -> {\r\n                    if (result.getResultCode() != Activity.RESULT_OK || result.getData() == null) return;\r\n                    Intent data = result.getData();\r\n\r\n                    try {\r\n                        if (data.getClipData() != null) {\r\n                            int count = data.getClipData().getItemCount();\r\n                            for (int i = 0; i < count; i++) {\r\n                                Uri u = data.getClipData().getItemAt(i).getUri();\r\n                                getContentResolver().takePersistableUriPermission(\r\n                                        u, Intent.FLAG_GRANT_READ_URI_PERMISSION);\r\n                                galeriaUris.add(u);\r\n                            }\r\n                        } else if (data.getData() != null) {\r\n                            Uri u = data.getData();\r\n                            getContentResolver().takePersistableUriPermission(\r\n                                    u, Intent.FLAG_GRANT_READ_URI_PERMISSION);\r\n                            galeriaUris.add(u);\r\n                        }\r\n                    } catch (SecurityException ignore) {\r\n                        if (data.getData() != null) galeriaUris.add(data.getData());\r\n                    }\r\n\r\n                    if (binding.scrEmpresa.rvGaleria.getAdapter() != null) {\r\n                        binding.scrEmpresa.rvGaleria.getAdapter().notifyDataSetChanged();\r\n                    }\r\n                    actualizarChecklistYEstado();\r\n                });\r\n\r\n        // Launcher para seleccionar ubicaci├│n\r\n        pickLocationLauncher = registerForActivityResult(\r\n                new ActivityResultContracts.StartActivityForResult(), result -> {\r\n                    if (result.getResultCode() != Activity.RESULT_OK || result.getData() == null) return;\r\n                    Intent d = result.getData();\r\n\r\n                    empresa.direccion = d.getStringExtra(\"direccion\");\r\n                    empresa.lat = d.getDoubleExtra(\"lat\", 0d);\r\n                    empresa.lon = d.getDoubleExtra(\"lon\", 0d);\r\n\r\n                    binding.scrEmpresa.tvDireccion.setText(\r\n                            (empresa.direccion == null || empresa.direccion.isEmpty())\r\n                                    ? \"Sin direcci├│n\"\r\n                                    : empresa.direccion\r\n                    );\r\n\r\n                    updateMapPreview();\r\n                    actualizarChecklistYEstado();\r\n                });\r\n    }\r\n\r\n    private void initializeAllSections() {\r\n        initEmpresaSection();\r\n        initToursSection();\r\n        initGuiasSection();\r\n        initReportesSection();\r\n        initChatSection();\r\n        //initPerfilSection();\r\n        cargarPerfilActual();\r\n        configurarAccionesPerfil();\r\n    }\r\n\r\n    // ===================== NAVIGATION =====================\r\n\r\n    private boolean onBottomItemSelected(MenuItem item) {\r\n        int id = item.getItemId();\r\n        if (id == R.id.nav_empresa) { showScreen(SCR_EMPRESA); return true; }\r\n        else if (id == R.id.nav_tours) { showScreen(SCR_TOURS); return true; }\r\n        else if (id == R.id.nav_guias) { showScreen(SCR_GUIAS); return true; }\r\n        else if (id == R.id.nav_reportes) { showScreen(SCR_REPORTES); return true; }\r\n        else if (id == R.id.nav_chat) { showScreen(SCR_CHAT); return true; }\r\n        else if (id == R.id.nav_perfil) { showScreen(SCR_PERFIL); return true; }\r\n        return false;\r\n    }\r\n\r\n    // ===================== SECTION X: CHAT =====================\r\n    private void initChatSection() {\r\n        // Recycler\r\n        binding.scrChat.rvConversaciones.setLayoutManager(new LinearLayoutManager(this));\r\n        chatAdapter = new ConversationAdapter(this, c -> {\r\n            // Por ahora: aquí luego abres la Activity del chat\r\n            // Intent i = new Intent(this, ChatRoomActivity.class);\r\n            // i.putExtra(\"conversationId\", c.id);\r\n            // i.putExtra(\"otherUserId\", c.otherUserId);\r\n            // startActivity(i);\r\n            Snackbar.make(binding.getRoot(),\r\n                    \"Abrir chat con: \" + (c.title != null ? c.title : c.otherUserId),\r\n                    Snackbar.LENGTH_SHORT).show();\r\n        });\r\n        binding.scrChat.rvConversaciones.setAdapter(chatAdapter);\r\n\r\n        // Search\r\n        binding.scrChat.etBuscarChat.addTextChangedListener(new android.text.TextWatcher() {\r\n            @Override public void beforeTextChanged(CharSequence s, int start, int count, int after) {}\r\n            @Override public void onTextChanged(CharSequence s, int start, int before, int count) {\r\n                if (chatAdapter != null) chatAdapter.setQuery(String.valueOf(s));\r\n            }\r\n            @Override public void afterTextChanged(android.text.Editable s) {}\r\n        });\r\n\r\n        // Chips\r\n        binding.scrChat.chipTodos.setOnClickListener(v -> {\r\n            chatAdapter.setRoleFilter(\"ALL\");\r\n            chatAdapter.setUnreadOnly(binding.scrChat.chipNoLeidos.isChecked());\r\n        });\r\n\r\n        binding.scrChat.chipGuias.setOnClickListener(v -> {\r\n            chatAdapter.setRoleFilter(\"guia\");\r\n            chatAdapter.setUnreadOnly(binding.scrChat.chipNoLeidos.isChecked());\r\n        });\r\n\r\n        binding.scrChat.chipClientes.setOnClickListener(v -> {\r\n            chatAdapter.setRoleFilter(\"cliente\");\r\n            chatAdapter.setUnreadOnly(binding.scrChat.chipNoLeidos.isChecked());\r\n        });\r\n\r\n        binding.scrChat.chipNoLeidos.setOnClickListener(v -> {\r\n            chatAdapter.setUnreadOnly(binding.scrChat.chipNoLeidos.isChecked());\r\n        });\r\n\r\n        // Data inicial (MOCK por ahora, para que el flujo ya funcione)\r\n        chatData.clear();\r\n        chatData.add(new com.example.proyecto_2025.model.ConversationUI(\r\n                \"c1\", \"Guía: Juan Pérez\", \"Hola! ¿Listo para el tour?\", \"12:10\",\r\n                true, \"uid_guia_1\", \"guia\", \"\"\r\n        ));\r\n        chatData.add(new com.example.proyecto_2025.model.ConversationUI(\r\n                \"c2\", \"Cliente: María\", \"Gracias por la info\", \"Ayer\",\r\n                false, \"uid_cliente_9\", \"cliente\", \"\"\r\n        ));\r\n\r\n        chatAdapter.submit(chatData);\r\n        toggleEmptyChat();\r\n    }\r\n    private void toggleEmptyChat() {\r\n        boolean empty = (chatAdapter == null || chatAdapter.getItemCount() == 0);\r\n        binding.scrChat.emptyStateChat.setVisibility(empty ? View.VISIBLE : View.GONE);\r\n        binding.scrChat.rvConversaciones.setVisibility(empty ? View.GONE : View.VISIBLE);\r\n    }\r\n\r\n    private void showScreen(@IdRes int screenId) {\r\n        // Ocultar todas las pantallas\r\n        binding.scrEmpresa.getRoot().setVisibility(View.GONE);\r\n        binding.scrTours.getRoot().setVisibility(View.GONE);\r\n        binding.scrGuias.getRoot().setVisibility(View.GONE);\r\n        binding.scrReportes.getRoot().setVisibility(View.GONE);\r\n        binding.scrChat.getRoot().setVisibility(View.GONE);\r\n        binding.scrPerfil.getRoot().setVisibility(View.GONE);\r\n\r\n        // Mostrar pantalla seleccionada\r\n        View target =\r\n                (screenId == SCR_EMPRESA) ? binding.scrEmpresa.getRoot() :\r\n                        (screenId == SCR_TOURS) ? binding.scrTours.getRoot() :\r\n                                (screenId == SCR_GUIAS) ? binding.scrGuias.getRoot() :\r\n                                        (screenId == SCR_REPORTES) ? binding.scrReportes.getRoot() :\r\n                                                (screenId == SCR_CHAT) ? binding.scrChat.getRoot() :\r\n                                                        binding.scrPerfil.getRoot();\r\n\r\n        target.setVisibility(View.VISIBLE);\r\n\r\n        // FAB global apagado\r\n        binding.fab.setVisibility(View.GONE);\r\n        binding.fab.setOnClickListener(null);\r\n\r\n        if (screenId == SCR_GUIAS) refreshGuiasDashboard();\r\n        if (screenId == SCR_TOURS) loadToursEmpresa();\r\n\r\n        if (screenId == SCR_CHAT) initChatSection();  // o refreshChat();\r\n    }\r\n\r\n\r\n    // ===================== SECTION 1: EMPRESA =====================\r\n\r\n    private void initEmpresaSection() {\r\n        setupMapPreview();\r\n        updateMapPreview();\r\n\r\n        // Cargar datos previos\r\n        binding.scrEmpresa.etNombre.setText(empresa.nombre);\r\n        binding.scrEmpresa.etCorreo.setText(empresa.correo);\r\n        binding.scrEmpresa.etTelefono.setText(empresa.telefono);\r\n        binding.scrEmpresa.etWeb.setText(empresa.web);\r\n        binding.scrEmpresa.etDescripcion.setText(empresa.descripcion);\r\n\r\n        if (empresa.direccion != null && !empresa.direccion.isEmpty()) {\r\n            binding.scrEmpresa.tvDireccion.setText(empresa.direccion);\r\n        }\r\n\r\n        // Configurar galer├¡a\r\n        for (String s : empresa.imagenUris) galeriaUris.add(Uri.parse(s));\r\n        binding.scrEmpresa.rvGaleria.setLayoutManager(\r\n                new LinearLayoutManager(this, LinearLayoutManager.HORIZONTAL, false));\r\n        binding.scrEmpresa.rvGaleria.setAdapter(new ImageUriAdapter(galeriaUris, pos -> {\r\n            galeriaUris.remove(pos);\r\n            binding.scrEmpresa.rvGaleria.getAdapter().notifyItemRemoved(pos);\r\n            actualizarChecklistYEstado();\r\n        }));\r\n\r\n        // Botones\r\n        binding.scrEmpresa.btnAgregarFotos.setOnClickListener(v -> abrirPickerImagenes());\r\n        binding.scrEmpresa.btnElegirUbicacion.setOnClickListener(v -> abrirPickerUbicacion());\r\n        binding.scrEmpresa.btnGuardar.setOnClickListener(v -> guardarEmpresa(false));\r\n        binding.scrEmpresa.btnPublicar.setOnClickListener(v -> guardarEmpresa(true));\r\n\r\n        actualizarChecklistYEstado();\r\n    }\r\n\r\n    private void setupMapPreview() {\r\n        org.osmdroid.config.Configuration.getInstance().setUserAgentValue(getPackageName());\r\n        binding.scrEmpresa.mapPreview.setMultiTouchControls(false);\r\n        binding.scrEmpresa.mapPreview.setTileSource(\r\n                org.osmdroid.tileprovider.tilesource.TileSourceFactory.MAPNIK);\r\n        binding.scrEmpresa.mapPreview.getController().setZoom(4.0);\r\n        binding.scrEmpresa.mapPreview.getController().setCenter(\r\n                new org.osmdroid.util.GeoPoint(-9.19, -75.02)); // Per├║\r\n    }\r\n\r\n    private void updateMapPreview() {\r\n        boolean hasLoc = empresa != null && empresa.lat != 0 && empresa.lon != 0\r\n                && empresa.direccion != null && !empresa.direccion.isEmpty();\r\n\r\n        if (!hasLoc) {\r\n            binding.scrEmpresa.tvDireccion.setText(\"Sin dirección\");\r\n            binding.scrEmpresa.mapPreview.getOverlays().clear();\r\n            binding.scrEmpresa.mapPreview.getController().setZoom(4.0);\r\n            binding.scrEmpresa.mapPreview.getController().setCenter(\r\n                    new org.osmdroid.util.GeoPoint(-9.19, -75.02));\r\n            binding.scrEmpresa.mapPreview.invalidate();\r\n            return;\r\n        }\r\n\r\n        org.osmdroid.util.GeoPoint p = new org.osmdroid.util.GeoPoint(empresa.lat, empresa.lon);\r\n        binding.scrEmpresa.mapPreview.getOverlays().clear();\r\n\r\n        org.osmdroid.views.overlay.Marker m =\r\n                new org.osmdroid.views.overlay.Marker(binding.scrEmpresa.mapPreview);\r\n        m.setPosition(p);\r\n        m.setAnchor(org.osmdroid.views.overlay.Marker.ANCHOR_CENTER,\r\n                org.osmdroid.views.overlay.Marker.ANCHOR_BOTTOM);\r\n        m.setTitle(\"Ubicación seleccionada\");\r\n        binding.scrEmpresa.mapPreview.getOverlays().add(m);\r\n\r\n        binding.scrEmpresa.mapPreview.getController().setZoom(15.0);\r\n        binding.scrEmpresa.mapPreview.getController().setCenter(p);\r\n        binding.scrEmpresa.tvDireccion.setText(empresa.direccion);\r\n        binding.scrEmpresa.mapPreview.invalidate();\r\n    }\r\n\r\n    private void abrirPickerImagenes() {\r\n        Intent i = new Intent(Intent.ACTION_OPEN_DOCUMENT);\r\n        i.addCategory(Intent.CATEGORY_OPENABLE);\r\n        i.setType(\"image/*\");\r\n        i.putExtra(Intent.EXTRA_ALLOW_MULTIPLE, true);\r\n        i.putExtra(Intent.EXTRA_LOCAL_ONLY, true);\r\n        i.addFlags(Intent.FLAG_GRANT_PERSISTABLE_URI_PERMISSION |\r\n                Intent.FLAG_GRANT_READ_URI_PERMISSION);\r\n        pickImagesLauncher.launch(Intent.createChooser(i, \"Selecciona imágenes\"));\r\n    }\r\n\r\n    private void abrirPickerUbicacion() {\r\n        pickLocationLauncher.launch(new Intent(this, MapPickerActivity.class));\r\n    }\r\n\r\n    private void guardarEmpresa(boolean publicar) {\r\n        if (!capturarFormulario(publicar)) return;\r\n\r\n        // Definir estado lógico según acción\r\n        empresa.status = publicar ? \"active\" : \"pending\";\r\n        Log.d(\"EMPRESA_DEBUG\", \"guardarEmpresa(publicar=\" + publicar + \")\");\r\n        if (!capturarFormulario(publicar)) return;\r\n        empresa.status = publicar ? \"active\" : \"pending\";\r\n        persistir();\r\n\r\n        if (publicar && !empresa.esCompleta()) {\r\n            Snackbar.make(binding.getRoot(),\r\n                    \"Aún faltan requisitos para publicar.\", Snackbar.LENGTH_LONG).show();\r\n            return;\r\n        }\r\n\r\n        persistir();\r\n        String msg = publicar ? \"Perfil publicado\" : \"Empresa guardada\";\r\n        Snackbar.make(binding.getRoot(), msg, Snackbar.LENGTH_SHORT).show();\r\n    }\r\n\r\n\r\n    private boolean capturarFormulario(boolean validarTodo) {\r\n        EditText etNombre = binding.scrEmpresa.etNombre;\r\n        EditText etCorreo = binding.scrEmpresa.etCorreo;\r\n        EditText etTelefono = binding.scrEmpresa.etTelefono;\r\n        EditText etDescripcion = binding.scrEmpresa.etDescripcion;\r\n\r\n        empresa.nombre = etNombre.getText().toString().trim();\r\n        empresa.correo = etCorreo.getText().toString().trim();\r\n        empresa.telefono = etTelefono.getText().toString().trim();\r\n        empresa.web = binding.scrEmpresa.etWeb.getText().toString().trim();\r\n        empresa.descripcion = etDescripcion.getText().toString().trim();\r\n\r\n        // Validaciones\r\n        if (empresa.nombre.isEmpty()) {\r\n            etNombre.setError(\"Requerido\");\r\n            if (validarTodo) return false;\r\n        }\r\n\r\n        if (empresa.correo.isEmpty() || !Patterns.EMAIL_ADDRESS.matcher(empresa.correo).matches()) {\r\n            etCorreo.setError(\"Correo inválido\");\r\n            if (validarTodo) return false;\r\n        }\r\n\r\n        if (empresa.telefono.isEmpty()) {\r\n            etTelefono.setError(\"Requerido\");\r\n            if (validarTodo) return false;\r\n        }\r\n\r\n        if (validarTodo && empresa.descripcion.isEmpty()) {\r\n            etDescripcion.setError(\"Requerida\");\r\n            return false;\r\n        }\r\n\r\n        // Guardar URIs de galer├¡a\r\n        empresa.imagenUris.clear();\r\n        for (Uri u : galeriaUris) empresa.imagenUris.add(u.toString());\r\n\r\n        return true;\r\n    }\r\n\r\n    private void persistir() {\r\n        empresaRepo.save(empresa);\r\n        actualizarChecklistYEstado();\r\n    }\r\n\r\n\r\n    private void actualizarChecklistYEstado() {\r\n        setCheck(binding.scrEmpresa.chkContacto,\r\n                !empresa.correo.isEmpty() && !empresa.telefono.isEmpty());\r\n        setCheck(binding.scrEmpresa.chkUbicacion,\r\n                empresa.direccion != null && !empresa.direccion.isEmpty());\r\n        setCheck(binding.scrEmpresa.chkFotos, galeriaUris.size() >= 2);\r\n        setCheck(binding.scrEmpresa.chkDescripcion, !empresa.descripcion.isEmpty());\r\n\r\n        TextView tvEstado = binding.scrEmpresa.tvEstado;\r\n        boolean completa = empresa.esCompleta();\r\n        tvEstado.setText(completa ? \"Perfil completo\" : \"Perfil incompleto\");\r\n\r\n        Button btnPublicar = binding.scrEmpresa.btnPublicar;\r\n        btnPublicar.setEnabled(completa);\r\n    }\r\n\r\n    private void setCheck(TextView tv, boolean ok) {\r\n        // Guarda el texto base la primera vez en el tag\r\n        if (tv.getTag() == null) {\r\n            // quita posible prefijo viejo tipo \"✔ \" o \"• \"\r\n            String base = tv.getText().toString().replaceFirst(\"^[✔•]\\\\s*\", \"\");\r\n            tv.setTag(base);\r\n        }\r\n        String base = tv.getTag().toString();\r\n        tv.setText((ok ? \"✔ \" : \"• \") + base);\r\n    }\r\n\r\n\r\n    // ===================== SECTION 2: TOURS =====================\r\n\r\n    private void initToursSection() {\r\n\r\n        // Configurar RecyclerView (vertical, últimos tours)\r\n        LinearLayoutManager lm = new LinearLayoutManager(this,\r\n                LinearLayoutManager.VERTICAL, false);\r\n        binding.scrTours.rvUltimos.setLayoutManager(lm);\r\n\r\n        tourAdapter = new TourAdapter(\r\n                new ArrayList<>(),\r\n                t -> {\r\n                    // Ir al detalle del tour\r\n                    Intent i = new Intent(this, TourDetalleActivity.class);\r\n                    i.putExtra(\"id\", t.id);\r\n                    startActivity(i);\r\n                },\r\n                (t, anchor) -> {\r\n                    // menú \"more\" si quieres más adelante\r\n                }\r\n        );\r\n        binding.scrTours.rvUltimos.setAdapter(tourAdapter);\r\n\r\n        // Botón \"Ver todos\"\r\n        binding.scrTours.btnVerTodosUltimos.setOnClickListener(v ->\r\n                startActivity(new Intent(this, TourListActivity.class)));\r\n\r\n        // FAB \"Nuevo tour\"\r\n        binding.scrTours.fabNuevoTour.setVisibility(View.VISIBLE);\r\n        binding.scrTours.fabNuevoTour.setOnClickListener(v -> {\r\n            if (empresa == null || !empresa.esCompleta()) {\r\n                Snackbar.make(binding.getRoot(),\r\n                        \"Primero completa el perfil de tu empresa\",\r\n                        Snackbar.LENGTH_LONG).show();\r\n                binding.bottomNav.setSelectedItemId(R.id.nav_empresa);\r\n                return;\r\n            }\r\n            startActivity(new Intent(this, TourFormActivity.class));\r\n        });\r\n\r\n        // Filtros (chips)\r\n        binding.scrTours.chipTodos.setOnClickListener(v -> applyTourFilter());\r\n        binding.scrTours.chipFiltroPublicados.setOnClickListener(v -> applyTourFilter());\r\n        binding.scrTours.chipFiltroPendientes.setOnClickListener(v -> applyTourFilter());\r\n\r\n        // Cargar datos iniciales\r\n        loadToursEmpresa();\r\n    }\r\n\r\n    private void loadToursEmpresa() {\r\n        if (empresaId == null || empresaId.isEmpty()) {\r\n            // Si por alguna razón no hay sesión, no hacemos nada\r\n            return;\r\n        }\r\n\r\n        tourRepo.fetchToursByEmpresa(empresaId, new TourRepository.ToursCallback() {\r\n            @Override\r\n            public void onSuccess(List<Tour> tours) {\r\n                allTours.clear();\r\n                allTours.addAll(tours);\r\n\r\n                // Actualizar KPIs y filtros\r\n                actualizarKPIsTours(allTours);\r\n                applyTourFilter();\r\n            }\r\n\r\n            @Override\r\n            public void onError(Exception e) {\r\n                Snackbar.make(binding.getRoot(),\r\n                        \"Error al cargar tours: \" + e.getMessage(),\r\n                        Snackbar.LENGTH_LONG).show();\r\n            }\r\n        });\r\n    }\r\n\r\n    private void actualizarKPIsTours(List<Tour> tours) {\r\n        int publicados = 0, pendientes = 0, borradores = 0;\r\n\r\n        for (Tour tour : tours) {\r\n            if (tour.estado == null) continue;\r\n            switch (tour.estado) {\r\n                case PUBLICADO:\r\n                    publicados++;\r\n                    break;\r\n                case PENDIENTE_GUIA:\r\n                    pendientes++;\r\n                    break;\r\n                case BORRADOR:\r\n                    borradores++;\r\n                    break;\r\n            }\r\n        }\r\n\r\n        binding.scrTours.tvCountPublicados.setText(String.valueOf(publicados));\r\n        binding.scrTours.tvCountPendientes.setText(String.valueOf(pendientes));\r\n        binding.scrTours.tvCountBorradores.setText(String.valueOf(borradores));\r\n    }\r\n\r\n    private void applyTourFilter() {\r\n        List<Tour> filtered = new ArrayList<>();\r\n\r\n        boolean filterPublicados = binding.scrTours.chipFiltroPublicados.isChecked();\r\n        boolean filterPendientes = binding.scrTours.chipFiltroPendientes.isChecked();\r\n        boolean filterTodos      = binding.scrTours.chipTodos.isChecked()\r\n                || (!filterPublicados && !filterPendientes);\r\n\r\n        for (Tour t : allTours) {\r\n            if (t.estado == null) continue;\r\n\r\n            if (filterTodos) {\r\n                filtered.add(t);\r\n            } else if (filterPublicados && t.estado == TourEstado.PUBLICADO) {\r\n                filtered.add(t);\r\n            } else if (filterPendientes && t.estado == TourEstado.PENDIENTE_GUIA) {\r\n                filtered.add(t);\r\n            }\r\n        }\r\n\r\n        tourAdapter.replaceData(filtered);\r\n\r\n        // Empty state vs lista\r\n        if (filtered.isEmpty()) {\r\n            binding.scrTours.emptyState.setVisibility(View.VISIBLE);\r\n            binding.scrTours.rvUltimos.setVisibility(View.GONE);\r\n        } else {\r\n            binding.scrTours.emptyState.setVisibility(View.GONE);\r\n            binding.scrTours.rvUltimos.setVisibility(View.VISIBLE);\r\n        }\r\n    }\r\n\r\n    // ===================== SECTION 3: GU├ìAS =====================\r\n\r\n    private void initGuiasSection() {\r\n\r\n        // Botones\r\n        binding.scrGuias.btnExplorarGuias.setOnClickListener(v ->\r\n                startActivity(new Intent(this, GuideDirectoryActivity.class)));\r\n\r\n        binding.scrGuias.btnOfertasGuias.setText(\"\uD83D\uDCE8 Ver solicitudes de guías\");\r\n        binding.scrGuias.btnOfertasGuias.setOnClickListener(v ->\r\n                startActivity(new Intent(this, OfferInboxActivity.class)));\r\n\r\n        // KPI: Guías activos\r\n        binding.scrGuias.kpiGuiasActivos.setText(\r\n                String.valueOf(GuideRepository.get().all().size())\r\n        );\r\n\r\n        // KPI: Solicitudes pendientes\r\n        binding.scrGuias.kpiOfertasPendientes.setText(\r\n                String.valueOf(OfferRepository.get().byStatus(Offer.Status.PENDIENTE).size())\r\n        );\r\n\r\n        // KPI: Guías con tours asignados (ofertas aceptadas)\r\n        binding.scrGuias.kpiOfertasAceptadas.setText(\r\n                String.valueOf(OfferRepository.get().byStatus(Offer.Status.ACEPTADA).size())\r\n        );\r\n\r\n        // === SOLICITUDES RECIENTES ===\r\n        loadSolicitudesRecientes();\r\n\r\n        // === CARRUSEL DE GUÍAS SUGERIDOS ===\r\n        RecyclerView rv = binding.scrGuias.rvGuiasSugeridos;\r\n        rv.setLayoutManager(new LinearLayoutManager(\r\n                this,\r\n                LinearLayoutManager.HORIZONTAL,\r\n                false\r\n        ));\r\n\r\n        guiasAdapter = new GuideAdapter(this, sugeridos, new GuideAdapter.OnAction() {\r\n            @Override\r\n            public void onProfile(Guide g) {\r\n                Intent i = new Intent(Admin_HomeActivity.this, GuideProfileActivity.class);\r\n                i.putExtra(\"guide\", g);\r\n                startActivity(i);\r\n            }\r\n\r\n            @Override\r\n            public void onOffer(Guide g) {\r\n                // En este flujo ya no envías oferta desde aquí,\r\n                // si quisieras podrías abrir detalles del guía o dejarlo vacío.\r\n            }\r\n        });\r\n\r\n        rv.setAdapter(guiasAdapter);\r\n\r\n        // Cargar datos iniciales del carrusel\r\n        loadGuiasSugeridos();\r\n    }\r\n\r\n\r\n\r\n    private void refreshGuiasDashboard() {\r\n        // Actualizar KPIs\r\n        int pend = OfferRepository.get().byStatus(Offer.Status.PENDIENTE).size();\r\n        int acep = OfferRepository.get().byStatus(Offer.Status.ACEPTADA).size();\r\n        int activos = GuideRepository.get().all().size();\r\n\r\n        binding.scrGuias.kpiOfertasPendientes.setText(String.valueOf(pend));\r\n        binding.scrGuias.kpiOfertasAceptadas.setText(String.valueOf(acep));\r\n        binding.scrGuias.kpiGuiasActivos.setText(String.valueOf(activos));\r\n\r\n        // Actualizar gu├¡as sugeridos\r\n        sugeridos.clear();\r\n        List<Guide> all = GuideRepository.get().all();\r\n        for (int i = 0; i < Math.min(5, all.size()); i++) {\r\n            sugeridos.add(all.get(i));\r\n        }\r\n        guiasAdapter.notifyDataSetChanged();\r\n\r\n        binding.scrGuias.emptyStateGuias.setVisibility(\r\n                sugeridos.isEmpty() ? View.VISIBLE : View.GONE);\r\n    }\r\n\r\n    // ===================== SECTION 4: REPORTES =====================\r\n\r\n    private void initReportesSection() {\r\n        // Filtros de per├¡odo\r\n        binding.scrReportes.chipSemana.setOnClickListener(v -> cargarReportes(\"SEMANA\"));\r\n        binding.scrReportes.chipMes.setOnClickListener(v -> cargarReportes(\"MES\"));\r\n        binding.scrReportes.chipAnio.setOnClickListener(v -> cargarReportes(\"ANIO\"));\r\n\r\n        // Ver todas las transacciones\r\n        binding.scrReportes.btnVerTodasTransacciones.setOnClickListener(v -> {\r\n            Snackbar.make(binding.getRoot(),\r\n                    \"Funcionalidad en desarrollo\", Snackbar.LENGTH_SHORT).show();\r\n        });\r\n\r\n        // Cargar datos iniciales (mes)\r\n        cargarReportes(\"MES\");\r\n    }\r\n\r\n    private void cargarReportes(String periodo) {\r\n        // KPIs principales (datos de ejemplo - reemplazar con BD real)\r\n        switch (periodo) {\r\n            case \"SEMANA\":\r\n                binding.scrReportes.tvIngresosTotales.setText(\"S/ 2,850\");\r\n                binding.scrReportes.tvIngresosCambio.setText(\"+12% vs anterior\");\r\n                binding.scrReportes.tvReservasTotales.setText(\"12\");\r\n                binding.scrReportes.tvReservasCambio.setText(\"Ôåæ +3 vs anterior\");\r\n                break;\r\n            case \"MES\":\r\n                binding.scrReportes.tvIngresosTotales.setText(\"S/ 12,450\");\r\n                binding.scrReportes.tvIngresosCambio.setText(\"+15% vs anterior\");\r\n                binding.scrReportes.tvReservasTotales.setText(\"48\");\r\n                binding.scrReportes.tvReservasCambio.setText(\"+8 vs anterior\");\r\n                break;\r\n            case \"ANIO\":\r\n                binding.scrReportes.tvIngresosTotales.setText(\"S/ 148,900\");\r\n                binding.scrReportes.tvIngresosCambio.setText(\"+23% vs anterior\");\r\n                binding.scrReportes.tvReservasTotales.setText(\"567\");\r\n                binding.scrReportes.tvReservasCambio.setText(\"+89 vs anterior\");\r\n                break;\r\n        }\r\n\r\n        // KPIs secundarios\r\n        TourRepository tourRepo = new TourRepository(this);\r\n        int toursActivos = 0;\r\n        for (Tour t : tourRepo.findAll()) {\r\n            if (t.estado == TourEstado.PUBLICADO) toursActivos++;\r\n        }\r\n\r\n        binding.scrReportes.tvToursActivos.setText(String.valueOf(toursActivos));\r\n        binding.scrReportes.tvGuiasContratados.setText(\r\n                String.valueOf(GuideRepository.get().all().size()));\r\n        binding.scrReportes.tvSatisfaccion.setText(\"4.7\");\r\n    }\r\n\r\n    // ===================== SECTION 5: PERFIL =====================\r\n    private void cargarPerfilActual() {\r\n        if (FirebaseAuth.getInstance().getCurrentUser() == null) return;\r\n\r\n        String uid = FirebaseAuth.getInstance().getCurrentUser().getUid();\r\n\r\n        db.collection(\"users\").document(uid)\r\n                .addSnapshotListener((doc, error) -> {\r\n                    if (error != null || doc == null || !doc.exists()) return;\r\n\r\n                    User u = doc.toObject(User.class);\r\n                    if (u == null) return;\r\n\r\n                    // Actualizar la UI en tiempo real\r\n                    binding.scrPerfil.tvNombre.setText(\r\n                            u.getDisplayName() != null ? u.getDisplayName() : \"-\");\r\n                    binding.scrPerfil.tvEmail.setText(\r\n                            u.getEmail() != null ? u.getEmail() : \"-\");\r\n                    binding.scrPerfil.tvTelefono.setText(\r\n                            u.getPhone() != null ? u.getPhone() : \"-\");\r\n                    binding.scrPerfil.tvDni.setText(\r\n                            u.getDni() != null ? u.getDni() : \"-\");\r\n                    binding.scrPerfil.tvFechaNacimiento.setText(\r\n                            u.getFechaNacimiento() != null ? u.getFechaNacimiento() : \"-\");\r\n                    binding.scrPerfil.tvDomicilio.setText(\r\n                            u.getDomicilio() != null ? u.getDomicilio() : \"-\");\r\n\r\n                    String company = u.getCompanyId() != null ? u.getCompanyId() : \"Sin empresa\";\r\n                    binding.scrPerfil.tvEmpresaNombre.setText(company);\r\n\r\n                    binding.scrPerfil.tvRuc.setText(\"—\");\r\n\r\n                    String photoUrl = u.getPhotoUrl();\r\n                    if (photoUrl != null && !photoUrl.isEmpty()) {\r\n                        Glide.with(this)\r\n                                .load(photoUrl)\r\n                                .placeholder(R.drawable.ic_user_placeholder)\r\n                                .error(R.drawable.ic_user_placeholder)\r\n                                .into(binding.scrPerfil.imgFotoPerfil);\r\n                    }\r\n                });\r\n    }\r\n\r\n    /** Listeners básicos del screen Perfil (cerrar sesión, etc.) */\r\n    private void configurarAccionesPerfil() {\r\n        // Cerrar sesión\r\n        binding.scrPerfil.btnCerrarSesion.setOnClickListener(v -> {\r\n            new AuthRepository().signOut();\r\n\r\n            Intent i = new Intent(this, LoginActivity.class);\r\n            i.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK);\r\n            startActivity(i);\r\n        });\r\n\r\n        binding.scrPerfil.btnEditarPerfil.setOnClickListener(v -> {\r\n            Intent i = new Intent(this, EditarPerfilActivityAdmin.class);\r\n\r\n            i.putExtra(\"nombre\", binding.scrPerfil.tvNombre.getText().toString());\r\n            i.putExtra(\"email\", binding.scrPerfil.tvEmail.getText().toString());\r\n            i.putExtra(\"telefono\", binding.scrPerfil.tvTelefono.getText().toString());\r\n            i.putExtra(\"empresa\", binding.scrPerfil.tvEmpresaNombre.getText().toString());\r\n            i.putExtra(\"dni\", binding.scrPerfil.tvDni.getText().toString());\r\n            i.putExtra(\"fechaNacimiento\", binding.scrPerfil.tvFechaNacimiento.getText().toString());\r\n            i.putExtra(\"domicilio\", binding.scrPerfil.tvDomicilio.getText().toString());\r\n\r\n            startActivity(i);\r\n        });\r\n\r\n        // \uD83D\uDC49 SOLO CAMBIAR FOTO\r\n        binding.scrPerfil.btnCambiarFoto.setOnClickListener(v -> {\r\n            Intent i = new Intent(this, CambiarFotoActivityAdmin.class);\r\n            startActivity(i);\r\n        });\r\n\r\n        // Otros botones (editar perfil, cambiar foto, etc.) se pueden agregar luego.\r\n    }\r\n    /*\r\n    private void initPerfilSection() {\r\n        // Cargar datos del admin\r\n        binding.scrPerfil.tvNombre.setText(admin.getNombre());\r\n        binding.scrPerfil.tvEmail.setText(admin.getEmail());\r\n        binding.scrPerfil.tvTelefono.setText(\"+51 \" + admin.getTelefono());\r\n\r\n        // Datos de empresa\r\n        binding.scrPerfil.tvEmpresaNombre.setText(empresa.nombre);\r\n        binding.scrPerfil.tvRuc.setText(\"20123456789\");\r\n\r\n        // Botones\r\n        binding.scrPerfil.btnEditarPerfil.setOnClickListener(v -> mostrarDialogEditarPerfil());\r\n\r\n        binding.scrPerfil.btnCambiarFoto.setOnClickListener(v -> {\r\n            Snackbar.make(binding.getRoot(),\r\n                    \"Funcionalidad en desarrollo\", Snackbar.LENGTH_SHORT).show();\r\n        });\r\n\r\n        binding.scrPerfil.btnVerEmpresa.setOnClickListener(v -> {\r\n            binding.bottomNav.setSelectedItemId(R.id.nav_empresa);\r\n        });\r\n\r\n        // Switches\r\n        binding.scrPerfil.switchNotificaciones.setOnCheckedChangeListener((buttonView, isChecked) -> {\r\n            String msg = isChecked ? \"Notificaciones activadas\" : \"Notificaciones desactivadas\";\r\n            Snackbar.make(binding.getRoot(), msg, Snackbar.LENGTH_SHORT).show();\r\n        });\r\n\r\n        binding.scrPerfil.switchModoOscuro.setOnCheckedChangeListener((buttonView, isChecked) -> {\r\n            String msg = isChecked ? \"Modo oscuro activado\" : \"Modo oscuro desactivado\";\r\n            Snackbar.make(binding.getRoot(), msg, Snackbar.LENGTH_SHORT).show();\r\n        });\r\n\r\n        binding.scrPerfil.btnIdioma.setOnClickListener(v -> {\r\n            Snackbar.make(binding.getRoot(),\r\n                    \"Funcionalidad en desarrollo\", Snackbar.LENGTH_SHORT).show();\r\n        });\r\n\r\n        // Cerrar sesi├│n\r\n        binding.scrPerfil.btnCerrarSesion.setOnClickListener(v -> {\r\n            new AlertDialog.Builder(this)\r\n                    .setTitle(\"Cerrar sesión\")\r\n                    .setMessage(\"¿Estás seguro de que deseas cerrar sesión?\")\r\n                    .setPositiveButton(\"Sí\", (dialog, which) -> {\r\n\r\n                        // 1) Cerrar sesión en Firebase\r\n                        FirebaseAuth.getInstance().signOut();\r\n\r\n                        // 2) Limpiar repos locales\r\n                        adminRepo.clear();\r\n                        // si no tienes este método aún, créalo en EmpresaRepository\r\n                        empresaRepo.clear();\r\n\r\n                        // 3) Ir al login y limpiar historial\r\n                        Intent i = new Intent(this, LoginActivity.class);\r\n                        i.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK\r\n                                | Intent.FLAG_ACTIVITY_CLEAR_TASK\r\n                                | Intent.FLAG_ACTIVITY_CLEAR_TOP);\r\n                        startActivity(i);\r\n\r\n                        finish();\r\n                    })\r\n                    .setNegativeButton(\"Cancelar\", null)\r\n                    .show();\r\n        });\r\n\r\n    } */\r\n\r\n    private void mostrarDialogEditarPerfil() {\r\n        View dialogView = getLayoutInflater().inflate(R.layout.dialog_editar_perfil, null);\r\n\r\n        com.google.android.material.textfield.TextInputEditText etNombre =\r\n                dialogView.findViewById(R.id.etNombre);\r\n        com.google.android.material.textfield.TextInputEditText etEmail =\r\n                dialogView.findViewById(R.id.etEmail);\r\n        com.google.android.material.textfield.TextInputEditText etTelefono =\r\n                dialogView.findViewById(R.id.etTelefono);\r\n\r\n        // Llenar con datos actuales\r\n        etNombre.setText(admin.getNombre());\r\n        etEmail.setText(admin.getEmail());\r\n        etTelefono.setText(admin.getTelefono());\r\n\r\n        androidx.appcompat.app.AlertDialog dialog =\r\n                new androidx.appcompat.app.AlertDialog.Builder(this)\r\n                        .setView(dialogView)\r\n                        .create();\r\n\r\n        // Bot├│n cancelar\r\n        dialogView.findViewById(R.id.btnCancelar).setOnClickListener(v -> dialog.dismiss());\r\n\r\n        // Bot├│n guardar\r\n        dialogView.findViewById(R.id.btnGuardar).setOnClickListener(v -> {\r\n            String nombre = etNombre.getText().toString().trim();\r\n            String telefono = etTelefono.getText().toString().trim();\r\n\r\n            // Validaciones\r\n            if (nombre.isEmpty()) {\r\n                etNombre.setError(\"El nombre es requerido\");\r\n                return;\r\n            }\r\n\r\n            if (telefono.isEmpty() || telefono.length() < 9) {\r\n                etTelefono.setError(\"Teléfono inválido (mínimo 9 dígitos)\");\r\n                return;\r\n            }\r\n\r\n            // Actualizar admin (email NO cambia)\r\n            admin.setNombre(nombre);\r\n            admin.setTelefono(telefono);\r\n            adminRepo.save(admin);\r\n\r\n            // Actualizar UI\r\n            binding.scrPerfil.tvNombre.setText(admin.getNombre());\r\n            binding.scrPerfil.tvTelefono.setText(\"+51 \" + admin.getTelefono());\r\n\r\n            dialog.dismiss();\r\n            Snackbar.make(binding.getRoot(),\r\n                    \"Perfil actualizado Ô£ô\", Snackbar.LENGTH_SHORT).show();\r\n        });\r\n\r\n        dialog.show();\r\n    }\r\n\r\n    private void loadSolicitudesRecientes() {\r\n        List<Offer> pendientes = OfferRepository.get().byStatus(Offer.Status.PENDIENTE);\r\n\r\n        binding.scrGuias.tvContadorSolicitudes.setText(pendientes.size() + \" solicitudes\");\r\n\r\n        if (pendientes.isEmpty()) {\r\n            binding.scrGuias.emptyStateSolicitudes.setVisibility(View.VISIBLE);\r\n            binding.scrGuias.rvSolicitudesGuias.setVisibility(View.GONE);\r\n            return;\r\n        }\r\n\r\n        binding.scrGuias.emptyStateSolicitudes.setVisibility(View.GONE);\r\n        binding.scrGuias.rvSolicitudesGuias.setVisibility(View.VISIBLE);\r\n\r\n        OfferAdapter adapter = new OfferAdapter(\r\n                this,\r\n                pendientes,\r\n                new OfferAdapter.OnAction() {\r\n                    @Override\r\n                    public void onAssign(Offer o) {\r\n                        // Si quieres permitir asignar guía desde aquí:\r\n                        Intent i = new Intent(Admin_HomeActivity.this, AssignGuideActivity.class);\r\n                        i.putExtra(\"offerId\", o.getId());   // o.id si tu modelo no tiene getId()\r\n                        startActivity(i);\r\n                    }\r\n\r\n                    @Override\r\n                    public void onDetail(Offer o) {\r\n                        Intent i = new Intent(Admin_HomeActivity.this, OfferDetailActivity.class);\r\n                        i.putExtra(\"offerId\", o.getId());   // o.id si tu modelo no tiene getId()\r\n                        startActivity(i);\r\n                    }\r\n                }\r\n        );\r\n\r\n        binding.scrGuias.rvSolicitudesGuias.setLayoutManager(\r\n                new LinearLayoutManager(this, LinearLayoutManager.HORIZONTAL, false)\r\n        );\r\n        binding.scrGuias.rvSolicitudesGuias.setAdapter(adapter);\r\n    }\r\n\r\n\r\n\r\n    private void loadGuiasSugeridos() {\r\n        sugeridos.clear();\r\n        List<Guide> all = GuideRepository.get().all();\r\n        for (int i = 0; i < Math.min(5, all.size()); i++) {\r\n            sugeridos.add(all.get(i));\r\n        }\r\n        guiasAdapter.notifyDataSetChanged();\r\n\r\n        binding.scrGuias.emptyStateGuias.setVisibility(\r\n                sugeridos.isEmpty() ? View.VISIBLE : View.GONE\r\n        );\r\n    }\r\n\r\n\r\n\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/example/proyecto_2025/Activities_Administrador/Admin_HomeActivity.java b/app/src/main/java/com/example/proyecto_2025/Activities_Administrador/Admin_HomeActivity.java
--- a/app/src/main/java/com/example/proyecto_2025/Activities_Administrador/Admin_HomeActivity.java	(revision 8e0c2c26e391b998bc9d9ddecd98e3b870cfe01b)
+++ b/app/src/main/java/com/example/proyecto_2025/Activities_Administrador/Admin_HomeActivity.java	(date 1765767018259)
@@ -19,6 +19,7 @@
 import androidx.recyclerview.widget.RecyclerView;
 
 import com.bumptech.glide.Glide;
+import com.example.proyecto_2025.Activities_Chat.ChatRoomActivity;
 import com.example.proyecto_2025.Activities_Guia.EditarPerfilActivityGuia;
 import com.example.proyecto_2025.Activities_Superadmin.CambiarFotoActivity;
 import com.example.proyecto_2025.R;
@@ -28,6 +29,7 @@
 import com.example.proyecto_2025.adapter.OfferAdapter;
 import com.example.proyecto_2025.adapter.TourAdapter;
 import com.example.proyecto_2025.data.auth.AuthRepository;
+import com.example.proyecto_2025.data.repository.ChatRepository;
 import com.example.proyecto_2025.data.repository.EmpresaRepository;
 import com.example.proyecto_2025.data.repository.TourRepository;
 import com.example.proyecto_2025.data.repository.OfferRepository;
@@ -35,6 +37,7 @@
 import com.example.proyecto_2025.data.repository.AdminRepository;
 import com.example.proyecto_2025.databinding.ActivityAdminHomeBinding;
 import com.example.proyecto_2025.login.LoginActivity;
+import com.example.proyecto_2025.model.Conversation;
 import com.example.proyecto_2025.model.Empresa;
 import com.example.proyecto_2025.model.Guide;
 import com.example.proyecto_2025.model.Offer;
@@ -96,6 +99,9 @@
     // ===================== LIFECYCLE =====================
     @Override
     protected void onCreate(Bundle savedInstanceState) {
+        FirebaseUser u = FirebaseAuth.getInstance().getCurrentUser();
+        myUid = (u != null) ? u.getUid() : null;
+
         super.onCreate(savedInstanceState);
         binding = ActivityAdminHomeBinding.inflate(getLayoutInflater());
         setContentView(binding.getRoot());
@@ -125,6 +131,9 @@
     }
 
     // ===================== SETUP METHODS =====================
+    private final ChatRepository chatRepo = new ChatRepository();
+    private com.google.firebase.firestore.ListenerRegistration chatReg;
+    private String myUid;
 
     private void setupToolbar() {
         setSupportActionBar(binding.toolbar);
@@ -266,63 +275,113 @@
 
     // ===================== SECTION X: CHAT =====================
     private void initChatSection() {
-        // Recycler
-        binding.scrChat.rvConversaciones.setLayoutManager(new LinearLayoutManager(this));
-        chatAdapter = new ConversationAdapter(this, c -> {
-            // Por ahora: aquí luego abres la Activity del chat
-            // Intent i = new Intent(this, ChatRoomActivity.class);
-            // i.putExtra("conversationId", c.id);
-            // i.putExtra("otherUserId", c.otherUserId);
-            // startActivity(i);
-            Snackbar.make(binding.getRoot(),
-                    "Abrir chat con: " + (c.title != null ? c.title : c.otherUserId),
-                    Snackbar.LENGTH_SHORT).show();
-        });
-        binding.scrChat.rvConversaciones.setAdapter(chatAdapter);
+
+        // Evita re-crear listeners cada vez que entras al tab
+        if (chatAdapter == null) {
+            binding.scrChat.rvConversaciones.setLayoutManager(new LinearLayoutManager(this));
+
+            chatAdapter = new ConversationAdapter(this, c -> {
+                // Abrir sala real
+                Intent i = new Intent(this, ChatRoomActivity.class);
+                i.putExtra("conversationId", c.id);
+                i.putExtra("otherUserId", c.otherUserId);
+                startActivity(i);
+            });
+
+            binding.scrChat.rvConversaciones.setAdapter(chatAdapter);
 
-        // Search
-        binding.scrChat.etBuscarChat.addTextChangedListener(new android.text.TextWatcher() {
-            @Override public void beforeTextChanged(CharSequence s, int start, int count, int after) {}
-            @Override public void onTextChanged(CharSequence s, int start, int before, int count) {
-                if (chatAdapter != null) chatAdapter.setQuery(String.valueOf(s));
-            }
-            @Override public void afterTextChanged(android.text.Editable s) {}
-        });
+            // Search
+            binding.scrChat.etBuscarChat.addTextChangedListener(new android.text.TextWatcher() {
+                @Override public void beforeTextChanged(CharSequence s, int start, int count, int after) {}
+                @Override public void onTextChanged(CharSequence s, int start, int before, int count) {
+                    if (chatAdapter != null) chatAdapter.setQuery(String.valueOf(s));
+                }
+                @Override public void afterTextChanged(android.text.Editable s) {}
+            });
 
-        // Chips
-        binding.scrChat.chipTodos.setOnClickListener(v -> {
-            chatAdapter.setRoleFilter("ALL");
-            chatAdapter.setUnreadOnly(binding.scrChat.chipNoLeidos.isChecked());
-        });
-
-        binding.scrChat.chipGuias.setOnClickListener(v -> {
-            chatAdapter.setRoleFilter("guia");
-            chatAdapter.setUnreadOnly(binding.scrChat.chipNoLeidos.isChecked());
-        });
-
-        binding.scrChat.chipClientes.setOnClickListener(v -> {
-            chatAdapter.setRoleFilter("cliente");
-            chatAdapter.setUnreadOnly(binding.scrChat.chipNoLeidos.isChecked());
-        });
-
-        binding.scrChat.chipNoLeidos.setOnClickListener(v -> {
-            chatAdapter.setUnreadOnly(binding.scrChat.chipNoLeidos.isChecked());
-        });
+            // Chips
+            binding.scrChat.chipTodos.setOnClickListener(v -> {
+                chatAdapter.setRoleFilter("ALL");
+                chatAdapter.setUnreadOnly(binding.scrChat.chipNoLeidos.isChecked());
+            });
+            binding.scrChat.chipGuias.setOnClickListener(v -> {
+                chatAdapter.setRoleFilter("guia");
+                chatAdapter.setUnreadOnly(binding.scrChat.chipNoLeidos.isChecked());
+            });
+            binding.scrChat.chipClientes.setOnClickListener(v -> {
+                chatAdapter.setRoleFilter("cliente");
+                chatAdapter.setUnreadOnly(binding.scrChat.chipNoLeidos.isChecked());
+            });
+            binding.scrChat.chipNoLeidos.setOnClickListener(v -> {
+                chatAdapter.setUnreadOnly(binding.scrChat.chipNoLeidos.isChecked());
+            });
+        }
+
+        if (myUid == null) return;
+
+        // Listener Firestore (REAL)
+        if (chatReg != null) chatReg.remove();
+        chatReg = chatRepo.listenMyConversations(myUid, new ChatRepository.ConversationsCb() {
+            @Override
+            public void onData(List<Conversation> list) {
+                // Mapear a UI
+                List<com.example.proyecto_2025.model.ConversationUI> ui = new ArrayList<>();
+
+                for (Conversation c : list) {
+                    if (c == null) continue;
+
+                    String otherId = getOtherUserId(c, myUid);
+                    String otherRole = (c.roles != null && otherId != null) ? c.roles.get(otherId) : null;
+
+                    String otherName = (c.displayNames != null && otherId != null) ? c.displayNames.get(otherId) : null;
+                    String otherPhoto = (c.photoUrls != null && otherId != null) ? c.photoUrls.get(otherId) : null;
+
+                    boolean unread = (c.unread != null && c.unread.get(myUid) != null) && Boolean.TRUE.equals(c.unread.get(myUid));
+
+                    String title = buildTitle(otherRole, otherName, otherId);
+                    String time = ""; // si quieres, luego lo formateamos con updatedAt
 
-        // Data inicial (MOCK por ahora, para que el flujo ya funcione)
-        chatData.clear();
-        chatData.add(new com.example.proyecto_2025.model.ConversationUI(
-                "c1", "Guía: Juan Pérez", "Hola! ¿Listo para el tour?", "12:10",
-                true, "uid_guia_1", "guia", ""
-        ));
-        chatData.add(new com.example.proyecto_2025.model.ConversationUI(
-                "c2", "Cliente: María", "Gracias por la info", "Ayer",
-                false, "uid_cliente_9", "cliente", ""
-        ));
+                    com.example.proyecto_2025.model.ConversationUI row = new com.example.proyecto_2025.model.ConversationUI();
+                    row.id = c.id;
+                    row.title = title;
+                    row.lastMessage = (c.lastMessage != null) ? c.lastMessage : "";
+                    row.time = time;
+                    row.unread = unread;
+                    row.otherUserId = otherId;
+                    row.otherRole = otherRole;
+                    row.otherPhotoUrl = (otherPhoto != null) ? otherPhoto : "";
 
-        chatAdapter.submit(chatData);
+                    ui.add(row);
+                }
+
+                chatAdapter.submit(ui);
+                toggleEmptyChat();
+            }
+
+            @Override
+            public void onError(Exception e) {
+                Snackbar.make(binding.getRoot(), "Error chat: " + e.getMessage(), Snackbar.LENGTH_LONG).show();
+            }
+        });
+
         toggleEmptyChat();
     }
+
+    private String getOtherUserId(Conversation c, String myUid) {
+        if (c.participants == null) return null;
+        for (String p : c.participants) {
+            if (p != null && !p.equals(myUid)) return p;
+        }
+        return null;
+    }
+
+    private String buildTitle(String role, String name, String uid) {
+        String who = (name != null && !name.trim().isEmpty()) ? name : (uid != null ? uid : "Usuario");
+        if ("guia".equalsIgnoreCase(role)) return "Guía: " + who;
+        if ("cliente".equalsIgnoreCase(role)) return "Cliente: " + who;
+        return who;
+    }
+
     private void toggleEmptyChat() {
         boolean empty = (chatAdapter == null || chatAdapter.getItemCount() == 0);
         binding.scrChat.emptyStateChat.setVisibility(empty ? View.VISIBLE : View.GONE);
Index: app/src/main/java/com/example/proyecto_2025/Activities_Usuario/Cliente_HomeActivity.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.example.proyecto_2025.Activities_Usuario;\r\n\r\nimport android.content.Intent;\r\nimport android.os.Bundle;\r\nimport android.view.MenuItem;\r\nimport android.view.View;\r\nimport android.widget.Toast;\r\n\r\nimport androidx.annotation.IdRes;\r\nimport androidx.appcompat.app.AppCompatActivity;\r\n\r\nimport com.bumptech.glide.Glide;\r\nimport com.example.proyecto_2025.Activities_Guia.EditarPerfilActivityGuia;\r\nimport com.example.proyecto_2025.Activities_Superadmin.CambiarFotoActivity;\r\nimport com.example.proyecto_2025.R;\r\nimport com.example.proyecto_2025.data.auth.AuthRepository;\r\nimport com.example.proyecto_2025.databinding.ActivityUsuarioVistaInicialBinding;\r\nimport androidx.recyclerview.widget.LinearLayoutManager;\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\n\r\nimport com.example.proyecto_2025.login.LoginActivity;\r\nimport com.example.proyecto_2025.model.User;\r\nimport com.google.android.material.tabs.TabLayout;\r\n\r\nimport com.example.proyecto_2025.adapter.EmpresasAdapter;\r\nimport com.example.proyecto_2025.Activities_Usuario.EmpresaTurismo;\r\n\r\nimport com.google.firebase.auth.FirebaseAuth;\r\nimport com.google.firebase.firestore.FirebaseFirestore;\r\nimport com.google.firebase.firestore.DocumentSnapshot;\r\n\r\npublic class Cliente_HomeActivity extends AppCompatActivity {\r\n\r\n    private ActivityUsuarioVistaInicialBinding binding;\r\n\r\n    private FirebaseFirestore db;\r\n\r\n    // Raíces (ids de cada <include/>)\r\n    private static final int SCR_DASHBOARD = R.id.scrDashboard;\r\n    private static final int SCR_EXPLORAR  = R.id.scrExplorar;\r\n    private static final int SCR_RESERVAS     = R.id.scrReservas;\r\n    private static final int SCR_SEGUIMIENTO  = R.id.scrSeguimiento;\r\n\r\n    private static final int SCR_CHAT = R.id.scrChat;\r\n\r\n    private static final int SCR_PERFIL    = R.id.scrPerfil;\r\n\r\n\r\n\r\n\r\n    @Override protected void onCreate(Bundle savedInstanceState) {\r\n        super.onCreate(savedInstanceState);\r\n        binding = ActivityUsuarioVistaInicialBinding.inflate(getLayoutInflater());\r\n        setContentView(binding.getRoot());\r\n\r\n        db = FirebaseFirestore.getInstance();\r\n\r\n        setSupportActionBar(binding.toolbar);\r\n        if (getSupportActionBar() != null) {\r\n            getSupportActionBar().setTitle(\"\");\r\n            getSupportActionBar().setDisplayShowTitleEnabled(false);\r\n        }\r\n\r\n        // 1) Notifs + Seed\r\n        com.example.proyecto_2025.notif.NotificationHelper.ensureChannel(this);\r\n        com.example.proyecto_2025.data.seed.SeedLoader.loadIfNeeded(this);\r\n\r\n        // 2) Bottom bar\r\n        binding.bottomNav.setOnItemSelectedListener(this::onBottomItemSelected);\r\n\r\n        // 3) UI\r\n        setupRecyclerViewEmpresas();           // mock visual (puedes dejarlo igual)\r\n        setupRecyclerViewToursRecomendados();  // AHORA reserva real\r\n        setupRecyclerViewReservas();           // lee local (simple)\r\n        setupRecyclerViewItinerario();\r\n\r\n        // 4) Atajos\r\n        binding.scrDashboard.btnContactarSoporte.setOnClickListener(v -> {\r\n            binding.bottomNav.setSelectedItemId(R.id.nav_explorar);\r\n            showScreen(SCR_EXPLORAR);\r\n        });\r\n        binding.scrDashboard.btnMisReservas.setOnClickListener(v -> {\r\n            binding.bottomNav.setSelectedItemId(R.id.nav_reservas);\r\n            showScreen(SCR_RESERVAS);\r\n        });\r\n\r\n        // 5) Estado inicial + KPIs\r\n        binding.bottomNav.setSelectedItemId(R.id.nav_dashboard);\r\n        showScreen(SCR_DASHBOARD);\r\n        cargarKpisDesdeLocal();   // <--- NUEVO\r\n\r\n        // Perfil (datos del usuario actual)\r\n        cargarPerfilActual();\r\n        configurarAccionesPerfil();\r\n    }\r\n\r\n\r\n    private String currentUserEmail() {\r\n        return getSharedPreferences(\"user_prefs\", MODE_PRIVATE)\r\n                .getString(\"current_user_email\", \"usuario@demo.com\");\r\n    }\r\n\r\n    private void cargarKpisDesdeLocal() {\r\n        // Lee de ReservaRepository y refresca KPIs del dashboard y la pantalla de Reservas\r\n        new Thread(() -> {\r\n            com.example.proyecto_2025.data.repository.ReservaRepository repo =\r\n                    new com.example.proyecto_2025.data.repository.ReservaRepository(this);\r\n            String email = currentUserEmail();\r\n\r\n            int completadas = repo.countCompletadas(email);\r\n            double total = repo.totalGastado(email);\r\n\r\n            runOnUiThread(() -> {\r\n                // KPIs del Dashboard (usa tus TextViews según binding del layout)\r\n                binding.scrDashboard.txtTotalTours.setText(String.valueOf(completadas));\r\n                binding.scrDashboard.txtTotalInvertido.setText(String.format(\"S/ %.2f\", total));\r\n            });\r\n        }).start();\r\n    }\r\n\r\n    private boolean onBottomItemSelected(MenuItem item) {\r\n        int id = item.getItemId();\r\n        if (id == R.id.nav_dashboard)  { showScreen(SCR_DASHBOARD); return true; }\r\n        else if (id == R.id.nav_explorar) { showScreen(SCR_EXPLORAR); return true; }\r\n        else if (id == R.id.nav_reservas)  { showScreen(SCR_RESERVAS); return true; }\r\n        else if (id == R.id.nav_seguimiento) { showScreen(SCR_SEGUIMIENTO); return true; }\r\n        else if (id == R.id.nav_perfil) { showScreen(SCR_PERFIL); return true; }\r\n        return false;\r\n    }\r\n\r\n    private void showScreen(@IdRes int screenId) {\r\n        View vDash     = binding.scrDashboard.getRoot();\r\n        View vExplorar = binding.scrExplorar.getRoot();\r\n        View vReservas = binding.scrReservas.getRoot();\r\n        View vSeguimiento = binding.scrSeguimiento.getRoot();\r\n        View vChat = binding.scrChat.getRoot();\r\n\r\n\r\n        View vPerfil   = binding.scrPerfil.getRoot();\r\n\r\n        vDash.setVisibility(View.GONE);\r\n        vExplorar.setVisibility(View.GONE);\r\n        vReservas.setVisibility(View.GONE);\r\n        vSeguimiento.setVisibility(View.GONE);\r\n        vChat.setVisibility(View.GONE);\r\n\r\n        vPerfil.setVisibility(View.GONE);\r\n\r\n        View target =\r\n                (screenId == SCR_DASHBOARD) ? vDash :\r\n                        (screenId == SCR_EXPLORAR)  ? vExplorar :\r\n                                (screenId == SCR_RESERVAS)     ? vReservas :\r\n                                        (screenId == SCR_SEGUIMIENTO)  ? vSeguimiento :\r\n                                                (screenId == SCR_CHAT) ? vChat : vPerfil;\r\n\r\n\r\n        target.setVisibility(View.VISIBLE);\r\n    }\r\n\r\n    private void setupRecyclerViewEmpresas() {\r\n\r\n        binding.scrExplorar.rvEmpresasTurismo\r\n                .setLayoutManager(new LinearLayoutManager(this));\r\n\r\n        // Muestra un pequeño loader si quieres (puede ser un ProgressBar en el layout)\r\n        // binding.scrExplorar.progressEmpresas.setVisibility(View.VISIBLE);\r\n\r\n        db.collection(\"empresas\")\r\n                .whereEqualTo(\"status\", \"active\")      // solo empresas publicadas\r\n                .get()\r\n                .addOnSuccessListener(snaps -> {\r\n                    List<EmpresaTurismo> empresas = new ArrayList<>();\r\n\r\n                    for (DocumentSnapshot doc : snaps.getDocuments()) {\r\n                        String nombre       = doc.getString(\"nombre\");\r\n                        String descripcion  = doc.getString(\"descripcionCorta\");\r\n                        String direccion    = doc.getString(\"direccion\");\r\n\r\n                        Double ratingDb     = doc.getDouble(\"ratingPromedio\");\r\n                        Double totalResDb   = doc.getDouble(\"totalReservas\");\r\n                        Double totalToursDb = doc.getDouble(\"totalToursActivos\"); // si lo agregas luego\r\n\r\n                        float rating        = ratingDb   != null ? ratingDb.floatValue() : 0f;\r\n                        int totalResenas    = totalResDb != null ? totalResDb.intValue() : 0;\r\n                        int totalTours      = totalToursDb != null ? totalToursDb.intValue() : 0;\r\n                        String empresaDocId = doc.getId();\r\n\r\n                        // Usa el mismo modelo visual que ya tienes\r\n                        EmpresaTurismo e = new EmpresaTurismo(\r\n                                empresaDocId,\r\n                                nombre != null ? nombre : \"Sin nombre\",\r\n                                descripcion != null ? descripcion : \"\",\r\n                                rating,\r\n                                totalResenas,\r\n                                totalTours,\r\n                                direccion != null ? direccion : \"Sin dirección\",\r\n                                R.drawable.ic_business_24   // icono default\r\n                        );\r\n                        empresas.add(e);\r\n                    }\r\n\r\n                    EmpresasAdapter adapter = new EmpresasAdapter(\r\n                            empresas,\r\n                            new EmpresasAdapter.OnEmpresaClickListener() {\r\n                                @Override\r\n                                public void onEmpresaClick(EmpresaTurismo empresa) {\r\n                                    // TODO: abrir detalles de la empresa (otra activity)\r\n                                }\r\n\r\n                                @Override\r\n                                public void onVerToursClick(EmpresaTurismo empresa) {\r\n                                    Intent i = new Intent(Cliente_HomeActivity.this, ToursPorEmpresaActivity.class);\r\n                                    i.putExtra(\"empresaDocId\", empresa.getId());\r\n                                    i.putExtra(\"empresaNombre\", empresa.getNombre());\r\n                                    startActivity(i);\r\n                                }\r\n                            }\r\n                    );\r\n\r\n                    binding.scrExplorar.rvEmpresasTurismo.setAdapter(adapter);\r\n                    // binding.scrExplorar.progressEmpresas.setVisibility(View.GONE);\r\n                })\r\n                .addOnFailureListener(err -> {\r\n                    Toast.makeText(this,\r\n                            \"Error cargando empresas: \" + err.getMessage(),\r\n                            Toast.LENGTH_LONG).show();\r\n                    // binding.scrExplorar.progressEmpresas.setVisibility(View.GONE);\r\n                });\r\n    }\r\n\r\n\r\n\r\n\r\n\r\n    private void setupRecyclerViewToursRecomendados() {\r\n        // Los ítems siguen siendo UI de ejemplo, pero al hacer click creamos una reserva REAL\r\n        List<TourRecomendado> tours = crearToursRecomendados();\r\n\r\n        ToursRecomendadosAdapter adapter = new ToursRecomendadosAdapter(tours, tour -> {\r\n            // Para enlazar con nuestra DB local, elegimos un tour por nombre\r\n            new Thread(() -> {\r\n                var db = com.example.proyecto_2025.data.local.db.AppDatabase.get(this);\r\n                // Busca el primero que tenga ese nombre en la semilla\r\n                var list = db.tourDao().getAll();\r\n                long tourId = -1;\r\n                for (var t : list) if (t.nombre.equalsIgnoreCase(tour.getNombre())) { tourId = t.id; break; }\r\n                if (tourId == -1 && !list.isEmpty()) tourId = list.get(0).id; // fallback\r\n\r\n                var repo = new com.example.proyecto_2025.data.repository.ReservaRepository(this);\r\n                long resId = repo.crearReserva(tourId, currentUserEmail());\r\n\r\n                runOnUiThread(() -> {\r\n                    Toast.makeText(this,\r\n                            resId > 0 ? \"Reserva creada y notificada\" : \"No se pudo crear la reserva\",\r\n                            Toast.LENGTH_SHORT).show();\r\n                    // Refresca KPIs y lista de reservas\r\n                    cargarKpisDesdeLocal();\r\n                    refrescarListaReservasProximas();\r\n                });\r\n            }).start();\r\n        });\r\n\r\n        binding.scrDashboard.rvToursRecomendados.setLayoutManager(\r\n                new LinearLayoutManager(this, LinearLayoutManager.HORIZONTAL, false));\r\n        binding.scrDashboard.rvToursRecomendados.setAdapter(adapter);\r\n    }\r\n\r\n    private void refrescarListaReservasProximas() {\r\n        new Thread(() -> {\r\n            var repo = new com.example.proyecto_2025.data.repository.ReservaRepository(this);\r\n            var proximas = repo.proximas(currentUserEmail());\r\n            // Mapear a tu modelo visual Reserva (nombre, fecha, empresa, estado, imagen)\r\n            List<Reserva> ui = new ArrayList<>();\r\n            var db = com.example.proyecto_2025.data.local.db.AppDatabase.get(this);\r\n            for (var r : proximas) {\r\n                var t = db.tourDao().find(r.tourId);\r\n                ui.add(new Reserva(t.nombre,\r\n                        new java.text.SimpleDateFormat(\"dd MMM yyyy\").format(new java.util.Date(t.inicioUtc)),\r\n                        \"Empresa\", \"Próxima\", // empresa real lo añadiremos luego con JOIN\r\n                        R.drawable.macchupicchu // placeholder según portadaKey\r\n                ));\r\n            }\r\n            runOnUiThread(() -> {\r\n                binding.scrReservas.recyclerViewReservas.setLayoutManager(new LinearLayoutManager(this));\r\n                binding.scrReservas.recyclerViewReservas.setAdapter(new ReservasAdapter(ui));\r\n            });\r\n        }).start();\r\n    }\r\n\r\n\r\n    private List<TourRecomendado> crearToursRecomendados() {\r\n        List<TourRecomendado> tours = new ArrayList<>();\r\n\r\n        tours.add(new TourRecomendado(\"Tour Machu Picchu\", \"Inka Expeditions\",\r\n                \"S/ 350\", 4.5f, \"2 días\", R.drawable.macchupicchu));\r\n        tours.add(new TourRecomendado(\"Salkantay Trek\", \"Mountain Adventures\",\r\n                \"S/ 280\", 4.3f, \"3 días\", R.drawable.salcantay));\r\n        tours.add(new TourRecomendado(\"Valle Sagrado\", \"Sacred Valley Tours\",\r\n                \"S/ 120\", 4.7f, \"1 día\", R.drawable.vallesagrado));\r\n\r\n        return tours;\r\n    }\r\n\r\n    private void setupRecyclerViewReservas() {\r\n        List<Reserva> todasLasReservas = crearReservasEstaticas();\r\n\r\n        actualizarEstadisticas(todasLasReservas);\r\n\r\n        // Inicializar con reservas próximas\r\n        List<Reserva> reservasProximas = filtrarPorEstado(todasLasReservas, \"Próxima\");\r\n        ReservasAdapter adapter = new ReservasAdapter(reservasProximas);\r\n\r\n        binding.scrReservas.recyclerViewReservas.setLayoutManager(new LinearLayoutManager(this));\r\n        binding.scrReservas.recyclerViewReservas.setAdapter(adapter);\r\n\r\n        // Listener para las pestañas\r\n        binding.scrReservas.tabLayoutReservas.addOnTabSelectedListener(new TabLayout.OnTabSelectedListener() {\r\n            @Override\r\n            public void onTabSelected(TabLayout.Tab tab) {\r\n                List<Reserva> reservasFiltradas;\r\n                switch (tab.getPosition()) {\r\n                    case 0: // Próximas\r\n                        reservasFiltradas = filtrarPorEstado(todasLasReservas, \"Próxima\");\r\n                        break;\r\n                    case 1: // Completadas\r\n                        reservasFiltradas = filtrarPorEstado(todasLasReservas, \"Completada\");\r\n                        break;\r\n                    case 2: // Canceladas\r\n                        reservasFiltradas = filtrarPorEstado(todasLasReservas, \"Cancelada\");\r\n                        break;\r\n                    default:\r\n                        reservasFiltradas = todasLasReservas;\r\n                }\r\n                ReservasAdapter nuevoAdapter = new ReservasAdapter(reservasFiltradas);\r\n                binding.scrReservas.recyclerViewReservas.setAdapter(nuevoAdapter);\r\n            }\r\n\r\n            @Override\r\n            public void onTabUnselected(TabLayout.Tab tab) {}\r\n\r\n            @Override\r\n            public void onTabReselected(TabLayout.Tab tab) {}\r\n        });\r\n    }\r\n\r\n    private List<Reserva> crearReservasEstaticas() {\r\n        List<Reserva> reservas = new ArrayList<>();\r\n        reservas.add(new Reserva(\"Tour Machu Picchu\", \"15 Oct 2025\",\r\n                \"Inca Expeditions\", \"Próxima\", R.drawable.macchupicchu));\r\n        reservas.add(new Reserva(\"Salkantay Trek\", \"10 Nov 2025\",\r\n                \"Mountain Adventures\", \"Próxima\", R.drawable.salcantay));\r\n        reservas.add(new Reserva(\"Valle Sagrado\", \"20 Sep 2025\",\r\n                \"Peru Tours\", \"Completada\", R.drawable.vallesagrado));\r\n        reservas.add(new Reserva(\"Lago Titicaca\", \"05 Ago 2025\",\r\n                \"Puno Trips\", \"Cancelada\", R.drawable.lagotiticaca));\r\n        return reservas;\r\n    }\r\n\r\n    private List<Reserva> filtrarPorEstado(List<Reserva> reservas, String estado) {\r\n        List<Reserva> filtradas = new ArrayList<>();\r\n        for (Reserva reserva : reservas) {\r\n            if (reserva.getEstado().equals(estado)) {\r\n                filtradas.add(reserva);\r\n            }\r\n        }\r\n        return filtradas;\r\n    }\r\n\r\n    private void actualizarEstadisticas(List<Reserva> todasLasReservas) {\r\n        int proximas = 0;\r\n        int completadas = 0;\r\n        int canceladas = 0;\r\n\r\n        for (Reserva r : todasLasReservas) {\r\n            if (r.getEstado().equals(\"Próxima\")) proximas++;\r\n            else if (r.getEstado().equals(\"Completada\")) completadas++;\r\n            else if (r.getEstado().equals(\"Cancelada\")) canceladas++;\r\n        }\r\n\r\n        binding.scrReservas.txtReservasActivas.setText(String.valueOf(proximas));\r\n        binding.scrReservas.txtReservasCompletadas.setText(String.valueOf(completadas));\r\n        // El total gastado lo puedes dejar hardcodeado por ahora\r\n    }\r\n\r\n\r\n    private void setupRecyclerViewItinerario() {\r\n\r\n        binding.scrSeguimiento.layoutSinTourActivo.setVisibility(View.GONE);\r\n        binding.scrSeguimiento.bottomSheetContainer.setVisibility(View.VISIBLE);\r\n\r\n        List<LugarItinerario> itinerario = crearItinerarioEstatico();\r\n\r\n        ItinerarioAdapter adapter = new ItinerarioAdapter(itinerario);\r\n        binding.scrSeguimiento.rvItinerario.setLayoutManager(new LinearLayoutManager(this));\r\n        binding.scrSeguimiento.rvItinerario.setAdapter(adapter);\r\n    }\r\n\r\n    private List<LugarItinerario> crearItinerarioEstatico() {\r\n        List<LugarItinerario> lugares = new ArrayList<>();\r\n        lugares.add(new LugarItinerario(\"Qorikancha\", \"09:00\", true, false));\r\n        lugares.add(new LugarItinerario(\"Plaza de Armas\", \"10:30\", false, true));\r\n        lugares.add(new LugarItinerario(\"Sacsayhuamán\", \"12:00\", false, false));\r\n        lugares.add(new LugarItinerario(\"Q'enqo\", \"14:00\", false, false));\r\n        lugares.add(new LugarItinerario(\"Tambomachay\", \"15:30\", false, false));\r\n        return lugares;\r\n    }\r\n\r\n    // ================== PERFIL (SCR_PERFIL) ==================\r\n\r\n    /** Carga los datos del usuario logueado y los muestra en el screen Perfil */\r\n    private void cargarPerfilActual() {\r\n        if (FirebaseAuth.getInstance().getCurrentUser() == null) return;\r\n\r\n        String uid = FirebaseAuth.getInstance().getCurrentUser().getUid();\r\n\r\n        db.collection(\"users\").document(uid)\r\n                .addSnapshotListener((doc, error) -> {\r\n                    if (error != null || doc == null || !doc.exists()) return;\r\n\r\n                    User u = doc.toObject(User.class);\r\n                    if (u == null) return;\r\n\r\n                    // Actualizar la UI en tiempo real\r\n                    binding.scrPerfil.tvNombre.setText(\r\n                            u.getDisplayName() != null ? u.getDisplayName() : \"-\");\r\n                    binding.scrPerfil.tvEmail.setText(\r\n                            u.getEmail() != null ? u.getEmail() : \"-\");\r\n                    binding.scrPerfil.tvTelefono.setText(\r\n                            u.getPhone() != null ? u.getPhone() : \"-\");\r\n                    binding.scrPerfil.tvDni.setText(\r\n                            u.getDni() != null ? u.getDni() : \"-\");\r\n                    binding.scrPerfil.tvFechaNacimiento.setText(\r\n                            u.getFechaNacimiento() != null ? u.getFechaNacimiento() : \"-\");\r\n                    binding.scrPerfil.tvDomicilio.setText(\r\n                            u.getDomicilio() != null ? u.getDomicilio() : \"-\");\r\n\r\n                    String photoUrl = u.getPhotoUrl();\r\n                    if (photoUrl != null && !photoUrl.isEmpty()) {\r\n                        Glide.with(this)\r\n                                .load(photoUrl)\r\n                                .placeholder(R.drawable.ic_user_placeholder)\r\n                                .error(R.drawable.ic_user_placeholder)\r\n                                .into(binding.scrPerfil.imgFotoPerfil);\r\n                    }\r\n                });\r\n    }\r\n\r\n    /** Listeners básicos del screen Perfil (cerrar sesión, etc.) */\r\n    private void configurarAccionesPerfil() {\r\n        // Cerrar sesión\r\n        binding.scrPerfil.btnCerrarSesion.setOnClickListener(v -> {\r\n            new AuthRepository().signOut();\r\n\r\n            Intent i = new Intent(this, LoginActivity.class);\r\n            i.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK);\r\n            startActivity(i);\r\n        });\r\n\r\n        binding.scrPerfil.btnEditarPerfil.setOnClickListener(v -> {\r\n            Intent i = new Intent(this, EditarPerfilActivityCliente.class);\r\n\r\n            i.putExtra(\"nombre\", binding.scrPerfil.tvNombre.getText().toString());\r\n            i.putExtra(\"email\", binding.scrPerfil.tvEmail.getText().toString());\r\n            i.putExtra(\"telefono\", binding.scrPerfil.tvTelefono.getText().toString());\r\n            i.putExtra(\"dni\", binding.scrPerfil.tvDni.getText().toString());\r\n            i.putExtra(\"fechaNacimiento\", binding.scrPerfil.tvFechaNacimiento.getText().toString());\r\n            i.putExtra(\"domicilio\", binding.scrPerfil.tvDomicilio.getText().toString());\r\n\r\n            startActivity(i);\r\n        });\r\n\r\n        // \uD83D\uDC49 SOLO CAMBIAR FOTO\r\n        binding.scrPerfil.btnCambiarFoto.setOnClickListener(v -> {\r\n            Intent i = new Intent(this, CambiarFotoActivityCliente.class);\r\n            startActivity(i);\r\n        });\r\n\r\n        // Otros botones (editar perfil, cambiar foto, etc.) se pueden agregar luego.\r\n    }\r\n\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/example/proyecto_2025/Activities_Usuario/Cliente_HomeActivity.java b/app/src/main/java/com/example/proyecto_2025/Activities_Usuario/Cliente_HomeActivity.java
--- a/app/src/main/java/com/example/proyecto_2025/Activities_Usuario/Cliente_HomeActivity.java	(revision 8e0c2c26e391b998bc9d9ddecd98e3b870cfe01b)
+++ b/app/src/main/java/com/example/proyecto_2025/Activities_Usuario/Cliente_HomeActivity.java	(date 1765767893412)
@@ -10,17 +10,23 @@
 import androidx.appcompat.app.AppCompatActivity;
 
 import com.bumptech.glide.Glide;
+import com.example.proyecto_2025.Activities_Chat.ChatRoomActivity;
 import com.example.proyecto_2025.Activities_Guia.EditarPerfilActivityGuia;
 import com.example.proyecto_2025.Activities_Superadmin.CambiarFotoActivity;
 import com.example.proyecto_2025.R;
+import com.example.proyecto_2025.adapter.ConversationAdapter;
 import com.example.proyecto_2025.data.auth.AuthRepository;
+import com.example.proyecto_2025.data.repository.ChatRepository;
 import com.example.proyecto_2025.databinding.ActivityUsuarioVistaInicialBinding;
 import androidx.recyclerview.widget.LinearLayoutManager;
 import java.util.ArrayList;
 import java.util.List;
 
 import com.example.proyecto_2025.login.LoginActivity;
+import com.example.proyecto_2025.model.Conversation;
+import com.example.proyecto_2025.model.ConversationUI;
 import com.example.proyecto_2025.model.User;
+import com.google.android.material.snackbar.Snackbar;
 import com.google.android.material.tabs.TabLayout;
 
 import com.example.proyecto_2025.adapter.EmpresasAdapter;
@@ -29,10 +35,16 @@
 import com.google.firebase.auth.FirebaseAuth;
 import com.google.firebase.firestore.FirebaseFirestore;
 import com.google.firebase.firestore.DocumentSnapshot;
+import com.google.firebase.firestore.ListenerRegistration;
 
 public class Cliente_HomeActivity extends AppCompatActivity {
 
     private ActivityUsuarioVistaInicialBinding binding;
+    private final ChatRepository chatRepo = new ChatRepository();
+    private ListenerRegistration chatReg;
+
+    private ConversationAdapter chatAdapter;
+    private String myUid;
 
     private FirebaseFirestore db;
 
@@ -55,6 +67,10 @@
         setContentView(binding.getRoot());
 
         db = FirebaseFirestore.getInstance();
+        if (FirebaseAuth.getInstance().getCurrentUser() != null) {
+            myUid = FirebaseAuth.getInstance().getCurrentUser().getUid();
+        }
+        initChatSection();
 
         setSupportActionBar(binding.toolbar);
         if (getSupportActionBar() != null) {
@@ -125,9 +141,115 @@
         else if (id == R.id.nav_explorar) { showScreen(SCR_EXPLORAR); return true; }
         else if (id == R.id.nav_reservas)  { showScreen(SCR_RESERVAS); return true; }
         else if (id == R.id.nav_seguimiento) { showScreen(SCR_SEGUIMIENTO); return true; }
+        else if (id == R.id.nav_chat) { showScreen(SCR_CHAT); return true; }
         else if (id == R.id.nav_perfil) { showScreen(SCR_PERFIL); return true; }
         return false;
     }
+    private void initChatSection() {
+
+        if (chatAdapter == null) {
+            binding.scrChat.rvConversaciones.setLayoutManager(new LinearLayoutManager(this));
+
+            chatAdapter = new ConversationAdapter(this, c -> {
+                Intent i = new Intent(this, ChatRoomActivity.class);
+                i.putExtra("conversationId", c.id);
+                i.putExtra("otherUserId", c.otherUserId);
+                startActivity(i);
+            });
+
+            binding.scrChat.rvConversaciones.setAdapter(chatAdapter);
+
+            binding.scrChat.etBuscarChat.addTextChangedListener(new android.text.TextWatcher() {
+                @Override public void beforeTextChanged(CharSequence s, int start, int count, int after) {}
+                @Override public void onTextChanged(CharSequence s, int start, int before, int count) {
+                    chatAdapter.setQuery(String.valueOf(s));
+                }
+                @Override public void afterTextChanged(android.text.Editable s) {}
+            });
+
+            binding.scrChat.chipTodos.setOnClickListener(v -> {
+                chatAdapter.setRoleFilter("ALL");
+                chatAdapter.setUnreadOnly(binding.scrChat.chipNoLeidos.isChecked());
+            });
+
+            binding.scrChat.chipGuias.setOnClickListener(v -> {
+                chatAdapter.setRoleFilter("guia");
+                chatAdapter.setUnreadOnly(binding.scrChat.chipNoLeidos.isChecked());
+            });
+
+
+            binding.scrChat.chipNoLeidos.setOnClickListener(v -> {
+                chatAdapter.setUnreadOnly(binding.scrChat.chipNoLeidos.isChecked());
+            });
+        }
+
+        if (myUid == null) return;
+
+        if (chatReg != null) chatReg.remove();
+
+        chatReg = chatRepo.listenMyConversations(myUid, new ChatRepository.ConversationsCb() {
+            @Override
+            public void onData(List<Conversation> list) {
+                List<ConversationUI> ui = new ArrayList<>();
+
+                for (Conversation c : list) {
+                    if (c == null) continue;
+
+                    String otherId = getOtherUserId(c, myUid);
+                    String otherRole = (c.roles != null && otherId != null) ? c.roles.get(otherId) : null;
+
+                    String otherName = (c.displayNames != null && otherId != null) ? c.displayNames.get(otherId) : null;
+                    String otherPhoto = (c.photoUrls != null && otherId != null) ? c.photoUrls.get(otherId) : null;
+
+                    boolean unread = (c.unread != null && c.unread.get(myUid) != null) && Boolean.TRUE.equals(c.unread.get(myUid));
+
+                    ConversationUI row = new ConversationUI();
+                    row.id = c.id;
+                    row.otherUserId = otherId;
+                    row.otherRole = otherRole;
+                    row.otherPhotoUrl = otherPhoto != null ? otherPhoto : "";
+                    row.title = buildTitle(otherRole, otherName, otherId);
+                    row.lastMessage = c.lastMessage != null ? c.lastMessage : "";
+                    row.time = ""; // luego lo formateamos con updatedAt
+                    row.unread = unread;
+
+                    ui.add(row);
+                }
+
+                chatAdapter.submit(ui);
+                toggleEmptyChat();
+            }
+
+            @Override
+            public void onError(Exception e) {
+                Snackbar.make(binding.getRoot(), "Error chat: " + e.getMessage(), Snackbar.LENGTH_LONG).show();
+            }
+        });
+
+        toggleEmptyChat();
+    }
+
+    private void toggleEmptyChat() {
+        boolean empty = (chatAdapter == null || chatAdapter.getItemCount() == 0);
+        binding.scrChat.emptyStateChat.setVisibility(empty ? View.VISIBLE : View.GONE);
+        binding.scrChat.rvConversaciones.setVisibility(empty ? View.GONE : View.VISIBLE);
+    }
+
+    private String getOtherUserId(Conversation c, String myUid) {
+        if (c.participants == null) return null;
+        for (String p : c.participants) {
+            if (p != null && !p.equals(myUid)) return p;
+        }
+        return null;
+    }
+
+    private String buildTitle(String role, String name, String uid) {
+        String who = (name != null && !name.trim().isEmpty()) ? name : (uid != null ? uid : "Usuario");
+        if ("guia".equalsIgnoreCase(role)) return "Guía: " + who;
+        if ("cliente".equalsIgnoreCase(role)) return "Cliente: " + who;
+        return who;
+    }
+
 
     private void showScreen(@IdRes int screenId) {
         View vDash     = binding.scrDashboard.getRoot();
@@ -231,6 +353,11 @@
 
 
 
+    @Override
+    protected void onDestroy() {
+        super.onDestroy();
+        if (chatReg != null) chatReg.remove();
+    }
 
 
     private void setupRecyclerViewToursRecomendados() {
